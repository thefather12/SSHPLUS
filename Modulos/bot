#!/bin/bash
clear
[[ ! -d /etc/SSHPlus ]] && exit 0
[[ ! -d /etc/bot ]] && exit 0
source ShellBot.sh
# api_bot es el primer argumento
api_bot=$1
# id_admin es el segundo argumento
id_admin=$2
[[ -z $api_bot ]] && exit 0
[[ -z $id_admin ]] && exit 0
[[ ! -e /usr/lib/licence ]] && exit 0
# Lista de usuarios activos
ativos='/etc/bot/lista_ativos'
# Lista de usuarios suspendidos
suspensos='/etc/bot/lista_suspensos'
ShellBot.init --token "$api_bot" --monitor --return map --flush
ShellBot.username

fun_menu() {
    # Si el remitente es el administrador
    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
        local env_msg
        env_msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        env_msg+="<b>ü§ñ BIENVENIDO(a) AL BOT HIRVIP HB ü§ñ</b>\n"
        env_msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        env_msg+="‚ö†Ô∏è <i>SELECCIONE UNA OPCI√ìN ABAJO !</i>\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} --text "$env_msg" \
            --reply_markup "$keyboard1" \
            --parse_mode html
        return 0
    }
    # Si el usuario est√° suspendido
    [[ -d /etc/bot/suspensos/${message_from_username} ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "üö´ EST√ÅS SUSPENDIDO üö´\n\nCONTACTA AL ADMINISTRADOR")"
        return 0
    }
    # Si el usuario es revendedor
    if [[ "$(grep -w "${message_from_username}" $ativos | grep -wc 'revenda')" != '0' ]]; then
        local env_msg
        env_msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        env_msg+="<b>ü§ñ BIENVENIDO(a) AL BOT HIRVIP HB ü§ñ</b>\n"
        env_msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        env_msg+="‚ö†Ô∏è <i>SELECCIONE UNA OPCI√ìN ABAJO !</i>\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} --text "$env_msg" \
            --reply_markup "$keyboard2" \
            --parse_mode html
        return 0
    # Si el usuario es subrevendedor
    elif [[ "$(grep -w "${message_from_username}" $ativos | grep -wc 'subrevenda')" != '0' ]]; then
        local env_msg
        env_msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        env_msg+="<b>ü§ñ BIENVENIDO(a) AL BOT HIRVIP HB ü§ñ</b>\n"
        env_msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        env_msg+="‚ö†Ô∏è <i>SELECCIONE UNA OPCI√ìN ABAJO !</i>\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} --text "$env_msg" \
            --reply_markup "$keyboard3" \
            --parse_mode html
        return 0
    # Acceso denegado
    else
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}

fun_ajuda() {
    [[ ${message_chat_id[$id]} == "" ]] && {
        id_chatuser="${callback_query_message_chat_id[$id]}"
        id_name="${callback_query_from_username}"
    } || {
        id_chatuser="${message_chat_id[$id]}"
        id_name="${message_from_username}"
    }
    # Si es el administrador
    if [[ "$id_chatuser" = "$id_admin" ]]; then
        local env_msg
        env_msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        env_msg+="<b>ü§ñ BIENVENIDO(a) AL BOT HIRVIP HB ü§ñ</b>\n"
        env_msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        env_msg+="‚ö†Ô∏è <i>Comandos Disponibles</i>\n\n"
        env_msg+="[<b>01</b>] /menu = Muestra el men√∫\n"
        env_msg+="[<b>02</b>] /info = Muestra informaci√≥n\n"
        env_msg+="[<b>03</b>] /ajuda = Informaci√≥n sobre opciones\n\n"
        env_msg+="‚ö†Ô∏è <i>Opciones Disponibles</i>\n\n"
        env_msg+="‚Ä¢ <u>CREAR USUARIO</u> = Crea usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>CREAR TEST</u> = Crea test ssh\n\n"
        env_msg+="‚Ä¢ <u>REMOVER</u> = Elimina usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>SUSPENDER</u> = Suspender usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>INFO USUARIOS</u> = Informaci√≥n del usuario\n\n"
        env_msg+="‚Ä¢ <u>USUARIOS ONLINE</u> = Muestra Usuarios en l√≠nea\n\n"
        env_msg+="‚Ä¢ <u>INFO VPS</u> = Informaci√≥n del servidor\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR CONTRASE√ëA</u> = Cambia contrase√±a ssh\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR L√çMITE</u> = Cambia l√≠mite ssh\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR FECHA</u> = Cambia fecha ssh\n\n"
        env_msg+="‚Ä¢ <u>EXPIRADOS</u> = Elimina ssh expirados\n\n"
        env_msg+="‚Ä¢ <u>BACKUP</u> = Crea Backup ssh y revendedores\n\n"
        env_msg+="‚Ä¢ <u>OPTIMIZAR</u> = Limpia la cach√© - ram\n\n"
        env_msg+="‚Ä¢ <u>SPEEDTEST</u> = Prueba de conexi√≥n\n\n"
        env_msg+="‚Ä¢ <u>ARCHIVOS</u> = Aloja Archivos\n\n"
        env_msg+="‚Ä¢ <u>REVENDEDORES</u> = Administrar Revendedores\n\n"
        env_msg+="‚Ä¢ <u>AUTOBACKUP</u> = Act/Des Backup autom√°tico\n\n"
        env_msg+="‚Ä¢ <u>REPORTE</u> = Informaci√≥n sobre revendedores\n\n"
        env_msg+="‚Ä¢ <u>AYUDA</u> = Informaci√≥n sobre opciones\n\n"
        ShellBot.sendMessage --chat_id $id_chatuser \
            --text "$(echo -e $env_msg)" \
            --parse_mode html
        return 0
    # Si el usuario est√° suspendido
    elif [[ -d /etc/bot/suspensos/$id_name ]]; then
        ShellBot.sendMessage --chat_id $id_chatuser \
            --text "$(echo -e "üö´ EST√ÅS SUSPENDIDO üö´\n\nCONTACTA AL ADMINISTRADOR")"
        return 0
    # Si el usuario es revendedor
    elif [[ "$(grep -w "$id_name" $ativos | awk '{print $NF}')" == 'revenda' ]]; then
        local env_msg
        env_msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        env_msg+="<b>ü§ñ BIENVENIDO(a) AL BOT HIRVIP HB ü§ñ</b>\n"
        env_msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        env_msg+="‚ö†Ô∏è <i>Comandos Disponibles</i>\n\n"
        env_msg+="[<b>01</b>] /menu = Muestra el men√∫\n"
        env_msg+="[<b>02</b>] /info = Muestra informaci√≥n\n"
        env_msg+="[<b>03</b>] /ajuda = Informaci√≥n sobre opciones\n\n"
        env_msg+="‚ö†Ô∏è <i>Opciones Disponibles</i>\n\n"
        env_msg+="‚Ä¢ <u>CREAR USUARIO</u> = Crea usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>CREAR TEST</u> = Crea test ssh\n\n"
        env_msg+="‚Ä¢ <u>REMOVER</u> = Elimina usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>SUSPENDER</u> = Suspender usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>INFO USUARIOS</u> = Informaci√≥n del usuario\n\n"
        env_msg+="‚Ä¢ <u>USUARIOS ONLINE</u> = Muestra Usuarios en l√≠nea\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR CONTRASE√ëA</u> = Cambia contrase√±a ssh\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR L√çMITE</u> = Cambia l√≠mite ssh\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR FECHA</u> = Cambia fecha ssh\n\n"
        env_msg+="‚Ä¢ <u>EXPIRADOS</u> = Elimina ssh expirados\n\n"
        env_msg+="‚Ä¢ <u>REVENDEDORES</u> = Administrar Revendedores\n\n"
        env_msg+="‚Ä¢ <u>REPORTE</u> = Informaci√≥n sobre revendedores\n\n"
        env_msg+="‚Ä¢ <u>AYUDA</u> = Informaci√≥n sobre opciones\n\n"
        ShellBot.sendMessage --chat_id $id_chatuser \
            --text "$(echo -e $env_msg)" \
            --parse_mode html
        return 0
    # Si el usuario es subrevendedor
    elif [[ "$(grep -w "$id_name" $ativos | awk '{print $NF}')" == 'subrevenda' ]]; then
        local env_msg
        env_msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        env_msg+="<b>ü§ñ BIENVENIDO(a) AL BOT HIRVIP HB ü§ñ</b>\n"
        env_msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        env_msg+="‚ö†Ô∏è <i>Comandos Disponibles</i>\n\n"
        env_msg+="[<b>01</b>] /menu = Muestra el men√∫\n"
        env_msg+="[<b>02</b>] /info = Muestra informaci√≥n\n"
        env_msg+="[<b>03</b>] /ajuda = Informaci√≥n sobre opciones\n\n"
        env_msg+="‚ö†Ô∏è <i>Opciones Disponibles</i>\n\n"
        env_msg+="‚Ä¢ <u>CREAR USUARIO</u> = Crea usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>CREAR TEST</u> = Crea test ssh\n\n"
        env_msg+="‚Ä¢ <u>REMOVER</u> = Elimina usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>SUSPENDER</u> = Suspender usuario ssh\n\n"
        env_msg+="‚Ä¢ <u>INFO USUARIOS</u> = Informaci√≥n del usuario\n\n"
        env_msg+="‚Ä¢ <u>USUARIOS ONLINE</u> = Muestra Usuarios en l√≠nea\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR CONTRASE√ëA</u> = Cambia contrase√±a ssh\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR L√çMITE</u> = Cambia l√≠mite ssh\n\n"
        env_msg+="‚Ä¢ <u>CAMBIAR FECHA</u> = Cambia fecha ssh\n\n"
        env_msg+="‚Ä¢ <u>EXPIRADOS</u> = Elimina ssh expirados\n\n"
        env_msg+="‚Ä¢ <u>AYUDA</u> = Informaci√≥n sobre opciones\n\n"
        ShellBot.sendMessage --chat_id $id_chatuser \
            --text "$(echo -e $env_msg)" \
            --parse_mode html
        return 0
    # Acceso denegado
    else
        ShellBot.sendMessage --chat_id $id_chatuser \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}

# Funci√≥n para verificar el acceso (traducido solo comentarios, l√≥gica original)
verifica_acesso() {
    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
        # Si el usuario est√° suspendido o no est√° activo, establece la variable de error.
        [[ "$(grep -wc ${message_from_username} $suspensos)" != '0' ]] || [[ "$(grep -wc ${message_from_username} $ativos)" == '0' ]] && {
            _erro="1"
            return 0
        }
    }
}

fun_adduser() {
    # Si el usuario est√° suspendido
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Si es el administrador o un usuario activo
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üë§ CREAR USUARIO üë§\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        # Acceso denegado
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

criar_user() {
    IP=$(cat /etc/IP)
    # Funci√≥n auxiliar para crear el archivo .ovpn
    newclient() {
        cp /etc/openvpn/client-common.txt ~/$1.ovpn
        echo "<ca>" >>~/$1.ovpn
        cat /etc/openvpn/easy-rsa/pki/ca.crt >>~/$1.ovpn
        echo "</ca>" >>~/$1.ovpn
        echo "<cert>" >>~/$1.ovpn
        cat /etc/openvpn/easy-rsa/pki/issued/$1.crt >>~/$1.ovpn
        echo "</cert>" >>~/$1.ovpn
        echo "<key>" >>~/$1.ovpn
        cat /etc/openvpn/easy-rsa/pki/private/$1.key >>~/$1.ovpn
        echo "</key>" >>~/$1.ovpn
        echo "<tls-auth>" >>~/$1.ovpn
        cat /etc/openvpn/ta.key >>~/$1.ovpn
        echo "</tls-auth>" >>~/$1.ovpn
    }
    file_user=$1
    usuario=$(sed -n '1 p' $file_user | cut -d' ' -f2)
    senha=$(sed -n '2 p' $file_user | cut -d' ' -f2)
    limite=$(sed -n '3 p' $file_user | cut -d' ' -f2)
    data=$(sed -n '4 p' $file_user | cut -d' ' -f2)
    # Convierte la fecha de DD/MM/AAAA a AAAA/MM/DD para el comando useradd
    validade=$(echo "$data" | awk -F'/' '{print $2FS$1FS$3}' | xargs -i date -d'{}' +%Y/%m/%d)

    # Crea el usuario SSH con fecha de expiraci√≥n
    useradd -M -N -s /bin/false $usuario -e $validade >/dev/null 2>&1
    # Asigna la contrase√±a
    (
        echo "${senha}"
        echo "${senha}"
    ) | passwd "${usuario}" >/dev/null 2>&1
    # Si NO es el administrador, guarda la informaci√≥n para el revendedor
    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
        echo "$usuario:$senha:$info_data:$limite" >/etc/bot/revenda/${message_from_username}/usuarios/$usuario
        echo "$usuario:$senha:$info_data:$limite" >/etc/bot/info-users/$usuario
    }
    # Guarda el usuario y l√≠mite en la base de datos de usuarios
    echo "$usuario $limite" >>/root/usuarios.db
    # Guarda la contrase√±a
    echo "$senha" >/etc/SSHPlus/senha/$usuario
    # Si OpenVPN est√° configurado, crea los certificados y el archivo .ovpn
    [[ -e "/etc/openvpn/server.conf" ]] && {
        cd /etc/openvpn/easy-rsa/
        ./easyrsa build-client-full $usuario nopass
        newclient "$usuario"
    }
}

fun_deluser() {
    # Si el usuario est√° suspendido
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Si es el administrador o un usuario activo
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üóë ELIMINAR USUARIO üóë\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        # Acceso denegado
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

fun_del_user() {
    usuario=$1
    # Si es el administrador
    [[ "${message_from_id[$id]}" = "$id_admin" ]] && {
        # L√≥gica de eliminaci√≥n para el administrador (elimina de todo el sistema)
        piduser=$(ps -u "$usuario" | grep sshd | cut -d? -f1)
        kill -9 $piduser >/dev/null 2>&1
        userdel --force "$usuario" 2>/dev/null
        grep -v ^$usuario[[:space:]] /root/usuarios.db >/tmp/ph
        cat /tmp/ph >/root/usuarios.db
        rm /etc/SSHPlus/senha/$usuario >/dev/null 2>&1
    } || {
        # Si NO es el administrador, comprueba si el usuario existe bajo su revendedor
        [[ ! -e /etc/bot/revenda/${message_from_username}/usuarios/$usuario ]] && {
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå EL USUARIO NO EXISTE ‚ùå")" \
                --parse_mode html
            _erro='1'
            return 0
        }
        # L√≥gica de eliminaci√≥n para el revendedor (elimina del sistema y de los archivos del revendedor)
        piduser=$(ps -u "$usuario" | grep sshd | cut -d? -f1)
        kill -9 $piduser >/dev/null 2>&1
        userdel --force "$usuario" 2>/dev/null
        grep -v ^$usuario[[:space:]] /root/usuarios.db >/tmp/ph
        cat /tmp/ph >/root/usuarios.db
        rm /etc/SSHPlus/senha/$usuario >/dev/null 2>&1
        rm /etc/bot/revenda/${message_from_username}/usuarios/$usuario
        rm /etc/bot/info-users/$usuario
    }
    # Elimina el script de usuario de prueba si existe
    [[ -e /etc/SSHPlus/userteste/$usuario.sh ]] && rm /etc/SSHPlus/userteste/$usuario.sh
    # Si OpenVPN est√° configurado, revoca el certificado
    [[ -e "/etc/openvpn/easy-rsa/pki/private/$usuario.key" ]] && {
        [[ -e /etc/debian_version ]] && GROUPNAME=nogroup
        cd /etc/openvpn/easy-rsa/
        ./easyrsa --batch revoke $usuario
        ./easyrsa gen-crl
        rm -rf pki/reqs/$usuario.req
        rm -rf pki/private/$usuario.key
        rm -rf pki/issued/$usuario.crt
        rm -rf /etc/openvpn/crl.pem
        cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem
        chown nobody:$GROUPNAME /etc/openvpn/crl.pem
        [[ -e $HOME/$usuario.ovpn ]] && rm $HOME/$usuario.ovpn >/dev/null 2>&1
    }
}

fun_sususer() {
    # Si es el administrador
    if [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        arq_info=/tmp/$(echo $RANDOM)
        local info_users
        info_users='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_users+='<b>INFORMACI√ìN DE USUARIOS</b>\n'
        info_users+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'
        info_users+='‚ö†Ô∏è Muestra en el formato de abajo:\n\n'
        info_users+='<code>USUARIO CONTRASE√ëA L√çMITE FECHA</code>\n'
        ShellBot.sendMessage --chat_id $id_admin \
            --text "$(echo -e $info_users)" \
            --parse_mode html
        # Funci√≥n interna para obtener la informaci√≥n de todos los usuarios
        fun_infu() {
            local info
            # Itera sobre todos los usuarios del sistema
            for user in $(cat /etc/passwd | awk -F : '$3 >= 1000 {print $1}' | grep -v nobody); do
                info='===========================\n'
                # Obtiene contrase√±a
                [[ -e /etc/SSHPlus/senha/$user ]] && senha=$(cat /etc/SSHPlus/senha/$user) || senha='Null'
                # Obtiene l√≠mite
                [[ $(grep -wc $user $HOME/usuarios.db) != '0' ]] && limite=$(grep -w $user $HOME/usuarios.db | cut -d' ' -f2) || limite='Null'
                # Obtiene la fecha de expiraci√≥n
                datauser=$(chage -l $user | grep -i co | awk -F : '{print $2}')
                [[ $datauser = ' never' ]] && {
                    data="00/00/00"
                } || {
                    # Compara si ya expir√≥ (formato AAAA/MM/DD)
                    databr="$(date -d "$datauser" +"%Y%m%d")"
                    hoje="$(date -d today +"%Y%m%d")"
                    [[ $hoje -ge $databr ]] && {
                        data="Vencido"
                    } || {
                        # Calcula los d√≠as restantes
                        dat="$(date -d"$datauser" '+%Y-%m-%d')"
                        data=$(echo -e "$((($(date -ud $dat +%s) - $(date -ud $(date +%Y-%m-%d) +%s)) / 86400)) D√çAS")
                    }
                }
                info+="$user ‚Ä¢ $senha ‚Ä¢ $limite ‚Ä¢ $data"
                echo -e "$info"
            done
        }
        fun_infu >$arq_info
        # Env√≠a la informaci√≥n al administrador en bloques de 30 l√≠neas
        while :; do
            ShellBot.sendMessage --chat_id $id_admin \
                --text "$(while read linha; do echo $linha; done < <(sed '1,30!d' $arq_info))" \
                --parse_mode html
            sed -i 1,30d $arq_info
            # Sale del bucle cuando no quedan m√°s l√≠neas
            [[ $(cat $arq_info | wc -l) = '0' ]] && rm $arq_info && break
        done
        # Solicita el usuario a suspender
        ShellBot.sendMessage --chat_id $id_admin \
            --text "üóë SUSPENDER USUARIO üóë\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
        ShellBot.addHandler --function_call fun_sus_user --callback_data "suspend_user"
    # Si es un revendedor activo
    elif [[ "$(grep -wc "${callback_query_from_username}" $ativos)" != '0' ]]; then
        # Si el revendedor est√° suspendido (deber√≠a ser redundante, pero el script lo tiene)
        [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
            return 0
        }
        # Comprueba si el revendedor tiene usuarios creados
        [[ $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios | wc -l) == '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "¬°A√öN NO HAS CREADO NING√öN USUARIO!"
            return 0
        }
        arq_info=/tmp/$(echo $RANDOM)
        local info_users
        info_users='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_users+='<b>INFORMACI√ìN DE USUARIOS</b>\n'
        info_users+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'
        info_users+='‚ö†Ô∏è Muestra en el formato de abajo:\n\n'
        info_users+='<code>USUARIO CONTRASE√ëA L√çMITE FECHA</code>\n'
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e $info_users)" \
            --parse_mode html
        # Funci√≥n interna para obtener la informaci√≥n de los usuarios del revendedor
        fun_infu() {
            local info
            # Itera sobre los usuarios creados por este revendedor
            for user in $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios); do
                info='===========================\n'
                # Obtiene contrase√±a
                [[ -e /etc/SSHPlus/senha/$user ]] && senha=$(cat /etc/SSHPlus/senha/$user) || senha='Null'
                # Obtiene l√≠mite
                [[ $(grep -wc $user $HOME/usuarios.db) != '0' ]] && limite=$(grep -w $user $HOME/usuarios.db | cut -d' ' -f2) || limite='Null'
                # Obtiene la fecha de expiraci√≥n
                datauser=$(chage -l $user | grep -i co | awk -F : '{print $2}')
                [[ $datauser = ' never' ]] && {
                    data="00/00/00"
                } || {
                    # Compara si ya expir√≥ (formato AAAA/MM/DD)
                    databr="$(date -d "$datauser" +"%Y%m%d")"
                    hoje="$(date -d today +"%Y%m%d")"
                    [[ $hoje -ge $databr ]] && {
                        data="Vencido"
                    } || {
                        # Calcula los d√≠as restantes
                        dat="$(date -d"$datauser" '+%Y-%m-%d')"
                        data=$(echo -e "$((($(date -ud $dat +%s) - $(date -ud $(date +%Y-%m-%d) +%s)) / 86400)) D√çAS")
                    }
                }
                info+="$user ‚Ä¢ $senha ‚Ä¢ $limite ‚Ä¢ $data"
                echo -e "$info"
            done
        }
        fun_infu >$arq_info
        # Env√≠a la informaci√≥n al revendedor en bloques de 30 l√≠neas
        while :; do
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "$(while read linha; do echo $linha; done < <(sed '1,30!d' $arq_info))" \
                --parse_mode html
            sed -i 1,30d $arq_info
            [[ $(cat $arq_info | wc -l) = '0' ]] && rm $arq_info && break
        done
        # Solicita el usuario a suspender
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üóë SUSPENDER USUARIO üóë\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
        ShellBot.addHandler --function_call fun_sus_user --callback_data "suspend_user"
    # Acceso denegado
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}

fun_sus_user() {
    lock=$1  # Captura el nombre del usuario pasado como argumento en la variable lock
    if [[ "${message_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc "${callback_query_from_username}" $ativos)" != '0' ]]; then
        if id "$lock" &>/dev/null; then  # Verifica si el usuario existe
            passwd -l "$lock"  # Suspendiendo el usuario usando la variable lock
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚úÖ USUARIO $lock SUSPENDIDO CON √âXITO ‚úÖ")" \
                --parse_mode html
            
            # Agrega el usuario al archivo usuarios_suspensos
            echo "$lock" >> /etc/bot/usuarios_suspensos
            # Aseg√∫rate de que el archivo exista
            touch /etc/bot/usuarios_suspensos

        else
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå EL USUARIO NO EXISTE ‚ùå")" \
                --parse_mode html
        fi
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
    fi
}


fun_atiuser() {
    if [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        arq_info=/tmp/$(echo $RANDOM)
        local info_users
        info_users='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_users+='<b>USUARIOS SUSPENDIDOS</b>\n'
        info_users+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'

        while read user; do
            info_users+="$user\n"
        done < /etc/bot/usuarios_suspensos

        ShellBot.sendMessage --chat_id $id_admin \
            --text "$(echo -e $info_users)" \
            --parse_mode html

        ShellBot.sendMessage --chat_id $id_admin \
            --text "üóë REMOVER SUSPENSI√ìN üóë\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
        # La funci√≥n llamada es fun_ati_user (activar usuario)
        ShellBot.addHandler --function_call fun_ati_user --callback_data "suspend_user"
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}

fun_ati_user() {
    unlock=$1  # Captura el nombre del usuario pasado como argumento en la variable unlock
    if [[ "${message_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc "${callback_query_from_username}" $ativos)" != '0' ]]; then
        if id "$unlock" &>/dev/null; then  # Verifica si el usuario existe en el sistema
            if grep -q "$unlock" /etc/bot/usuarios_suspensos; then # Verifica si est√° en la lista de suspendidos
                passwd -u "$unlock"  # Reactiva el usuario (desbloquea la contrase√±a)
                ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                    --text "$(echo -e "‚úÖ USUARIO $unlock ACTIVADO CON √âXITO ‚úÖ")" \
                    --parse_mode html
                
                # Elimina el usuario del archivo usuarios_suspensos
                sed -i "/^$unlock$/d" /etc/bot/usuarios_suspensos
            else
                ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                    --text "$(echo -e "‚ùå EL USUARIO NO EST√Å SUSPENDIDO ‚ùå")" \
                    --parse_mode html
            fi
        else
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå EL USUARIO NO EXISTE ‚ùå")" \
                --parse_mode html
        fi
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
    fi
}

alterar_senha() {
    # Si el usuario est√° suspendido
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Si es el administrador o un usuario activo
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üîê CAMBIAR CONTRASE√ëA üîê\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        # Acceso denegado
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

alterar_senha_user() {
    usuario=$1
    senha=$2
    # Cambia la contrase√±a del usuario en el sistema
    echo "$usuario:$senha" | chpasswd
    # Actualiza la contrase√±a en el archivo de SSHPlus
    echo "$senha" >/etc/SSHPlus/senha/$usuario
    # Si el usuario fue creado por un revendedor (revenda), actualiza sus archivos de gesti√≥n
    [[ -e /etc/bot/revenda/${message_from_username}/usuarios/$usuario ]] && {
        senha2=$(cat /etc/bot/revenda/${message_from_username}/usuarios/$usuario | awk -F : {'print $2'})
        sed -i "/$usuario/ s/\b$senha2\b/$senha/g" /etc/bot/revenda/${message_from_username}/usuarios/$usuario
        sed -i "/$usuario/ s/\b$senha2\b/$senha/g" /etc/bot/info-users/$usuario
    }
    # Desconecta las sesiones activas del usuario
    [[ $(ps -u $usuario | grep sshd | wc -l) != '0' ]] && pkill -u $usuario >/dev/null 2>&1
}

alterar_senha_root() {
    # Si el usuario est√° suspendido
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }

    # Permite solo al administrador
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üîê CAMBIAR CONTRASE√ëA ROOT üîê\n\nIngresa la nueva contrase√±a:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        # Acceso denegado
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

alterar_senha_root_exec() {
    local senha=${message_text[$id]}
    local sizepass=$(echo -e ${#senha})

    # Verifica acceso
    verifica_acesso
    [[ "$_erro" == '1' ]] && return 0

    # Valida el tama√±o de la contrase√±a
    [[ "$sizepass" -lt '4' ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "‚ùå ¬°Error!\n\n‚ö†Ô∏è Usa un m√≠nimo de 4 caracteres [EJ: 1234]")" \
            --parse_mode html
        return 0
    }

    # Aplica la contrase√±a root
    echo "root:$senha" | chpasswd

    # Confirma resultado
    if [[ $? -eq 0 ]]; then
        local ip=$(hostname -I | awk '{print $1}')
        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
            --text "$(echo -e "=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n<b>‚úÖ ¬°CONTRASE√ëA ROOT CAMBIADA!</b>\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n\n<b>Usuario:</b> root\n<b>Nueva contrase√±a:</b> $senha\n<b>IP:</b> $ip")" \
            --parse_mode html
    else
        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
            --text "‚ùå Error al cambiar la contrase√±a root. Int√©ntalo de nuevo." \
            --parse_mode html
    fi
}

alterar_limite() {
    # Si el usuario est√° suspendido
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Si es el administrador o un usuario activo
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üë• CAMBIAR L√çMITE üë•\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        # Acceso denegado
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

alterar_limite_user() {
    usuario=$1
    limite=$2
    database="/root/usuarios.db"
    # Si es el administrador, actualiza el l√≠mite directamente en la base de datos principal
    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
        grep -v ^$usuario[[:space:]] /root/usuarios.db >/tmp/a
        mv /tmp/a /root/usuarios.db
        echo $usuario $limite >>/root/usuarios.db
        return 0
    }
    # Si es un revendedor
    [[ -d /etc/bot/revenda/${message_from_username} ]] && {
        # Verifica que el usuario pertenezca al revendedor
        [[ ! -e /etc/bot/revenda/${message_from_username}/usuarios/$usuario ]] && {
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå EL USUARIO NO EXISTE ‚ùå")" \
                --parse_mode html
            _erro='1'
            return 0
        }
        # Verifica el l√≠mite total del revendedor (obsoleto/redundante, pero mantenido)
        _limTotal=$(grep -w 'LIMITE_REVENDA' /etc/bot/revenda/${message_from_username}/${message_from_username} | awk '{print $NF}')
        [[ "$limite" -gt "$_limTotal" ]] && {
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå NO TIENES SUFICIENTE L√çMITE ‚ùå\n\nL√≠mite Actual: $_limTotal ")" \
                --parse_mode html
            _erro='1'
            return 0
        }
        # Obtiene el l√≠mite total asignado al revendedor (del archivo de activos)
        _limTotal=$(grep -w "${message_from_username}" $ativos | awk '{print $4}')
        # Llama a una funci√≥n para verificar el l√≠mite de usuarios *actuales* del revendedor
        fun_verif_limite_rev ${message_from_username}
        # Calcula la suma del l√≠mite actual de usuarios del revendedor m√°s el nuevo l√≠mite
        _limsomarev2=$(echo "$_result + $limite" | bc)
        echo "Total $_limsomarev2"
        # Comprueba si el nuevo total excede el l√≠mite asignado al revendedor
        [[ "$_limsomarev2" -gt "$_limTotal" ]] && {
            [[ "$_limTotal" == "$(($_limTotal - $_result))" ]] && _restant1='0' || _restant1=$(($_limTotal - $_result))
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå No tienes l√≠mite suficiente\n\nL√≠mite restante: $_restant1 ")" \
                --parse_mode html
            _erro='1'
            return 0
        }
        # Si las comprobaciones pasan, actualiza el l√≠mite en la base de datos principal
        grep -v ^$usuario[[:space:]] /root/usuarios.db >/tmp/a
        mv /tmp/a /root/usuarios.db
        echo $usuario $limite >>/root/usuarios.db
        # Actualiza el l√≠mite en los archivos del revendedor
        limite2=$(cat /etc/bot/revenda/${message_from_username}/usuarios/$usuario | awk -F : {'print $4'})
        sed -i "/\b$usuario\b/ s/\b$limite2\b/$limite/" /etc/bot/revenda/${message_from_username}/usuarios/$usuario
        sed -i "/\b$usuario\b/ s/\b$limite2\b/$limite/" /etc/bot/info-users/$usuario
    }
}

alterar_data() {
    # Si el usuario est√° suspendido
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Si es el administrador o un usuario activo
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "‚è≥ CAMBIAR FECHA ‚è≥\n\nNombre del usuario:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        # Acceso denegado
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

alterar_data_user() {
    usuario=$1
    inputdate=$2
    database="/root/usuarios.db"
    # Si la entrada es un n√∫mero de d√≠as (no contiene '//')
    [[ "$(echo -e "$inputdate" | sed -e 's/[^/]//ig')" != '//' ]] && {
        # Calcula la nueva fecha sumando los d√≠as (DD/MM/AAAA)
        udata=$(date "+%d/%m/%Y" -d "+$inputdate days")
        # Convierte al formato de sistema (AAAA-MM-DD)
        sysdate="$(echo "$udata" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
    } || {
        # Si la entrada es una fecha en formato DD/MM/AAAA
        udata=$(echo -e "$inputdate")
        # Convierte al formato de sistema (AAAA-MM-DD)
        sysdate="$(echo -e "$inputdate" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
        today="$(date -d today +"%Y%m%d")"
        timemachine="$(date -d "$sysdate" +"%Y%m%d")"
        # Verifica si la fecha es anterior o igual a hoy
        [ $today -ge $timemachine ] && {
            verify='1'
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "‚ùå ¬°Error! Fecha inv√°lida")" \
                --parse_mode html
            _erro='1'
            return 0
        }
    }
    # Aplica la nueva fecha de expiraci√≥n al usuario del sistema
    chage -E $sysdate $usuario
    # Si el usuario est√° en los archivos del revendedor, actualiza la fecha
    [[ -e /etc/bot/revenda/${message_from_username}/usuarios/$usuario ]] && {
        data2=$(cat /etc/bot/info-users/$usuario | awk -F : {'print $3'})
        sed -i "s;$data2;$udata;" /etc/bot/info-users/$usuario
        echo $usuario $udata ${message_from_username}
        sed -i "s;$data2;$udata;" /etc/bot/revenda/${message_from_username}/usuarios/$usuario
    }
}

ver_users() {
    # Si el usuario es el ADMINISTRADOR
    if [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        arq_info=/tmp/$(echo $RANDOM)
        local info_users
        info_users='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_users+='<b>INFORMACI√ìN DE USUARIOS</b>\n'
        info_users+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'
        info_users+='‚ö†Ô∏è Muestra en el formato de abajo:\n\n'
        info_users+='<code>USUARIO CONTRASE√ëA L√çMITE FECHA</code>\n'
        ShellBot.sendMessage --chat_id $id_admin \
            --text "$(echo -e $info_users)" \
            --parse_mode html
        
        # Funci√≥n interna para recopilar la informaci√≥n de TODOS los usuarios del sistema (UID >= 1000)
        fun_infu() {
            local info
            # Itera sobre todos los usuarios v√°lidos en /etc/passwd
            for user in $(cat /etc/passwd | awk -F : '$3 >= 1000 {print $1}' | grep -v nobody); do
                info='===========================\n'
                # Obtiene la contrase√±a
                [[ -e /etc/SSHPlus/senha/$user ]] && senha=$(cat /etc/SSHPlus/senha/$user) || senha='Null'
                # Obtiene el l√≠mite de conexi√≥n
                [[ $(grep -wc $user $HOME/usuarios.db) != '0' ]] && limite=$(grep -w $user $HOME/usuarios.db | cut -d' ' -f2) || limite='Null'
                # Obtiene la fecha de expiraci√≥n
                datauser=$(chage -l $user | grep -i co | awk -F : '{print $2}')
                
                [[ $datauser = ' never' ]] && {
                    data="00/00/00"
                } || {
                    # Comprueba si la fecha ya expir√≥
                    databr="$(date -d "$datauser" +"%Y%m%d")"
                    hoje="$(date -d today +"%Y%m%d")"
                    [[ $hoje -ge $databr ]] && {
                        data="Vencido"
                    } || {
                        # Calcula los d√≠as restantes
                        dat="$(date -d"$datauser" '+%Y-%m-%d')"
                        data=$(echo -e "$((($(date -ud $dat +%s) - $(date -ud $(date +%Y-%m-%d) +%s)) / 86400)) D√çAS")
                    }
                }
                info+="$user ‚Ä¢ $senha ‚Ä¢ $limite ‚Ä¢ $data"
                echo -e "$info"
            done
        }
        fun_infu >$arq_info
        # Env√≠a la informaci√≥n al administrador en bloques de 30 l√≠neas
        while :; do
            ShellBot.sendMessage --chat_id $id_admin \
                --text "$(while read linha; do echo $linha; done < <(sed '1,30!d' $arq_info))" \
                --parse_mode html
            sed -i 1,30d $arq_info
            # Sale del bucle cuando ya no quedan l√≠neas
            [[ $(cat $arq_info | wc -l) = '0' ]] && rm $arq_info && break
        done
        
    # Si es un usuario ACTIVO (revendedor)
    elif [[ "$(grep -wc "${callback_query_from_username}" $ativos)" != '0' ]]; then
        # Verifica si el revendedor est√° suspendido
        [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
            return 0
        }
        # Verifica si el revendedor ha creado usuarios
        [[ $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios | wc -l) == '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "¬°A√öN NO HAS CREADO NING√öN USUARIO!"
            return 0
        }
        
        arq_info=/tmp/$(echo $RANDOM)
        local info_users
        info_users='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_users+='<b>INFORMACI√ìN DE USUARIOS</b>\n'
        info_users+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'
        info_users+='‚ö†Ô∏è Muestra en el formato de abajo:\n\n'
        info_users+='<code>USUARIO CONTRASE√ëA L√çMITE FECHA</code>\n'
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e $info_users)" \
            --parse_mode html
            
        # Funci√≥n interna para recopilar la informaci√≥n de los usuarios creados por el revendedor
        fun_infu() {
            local info
            # Itera solo sobre los usuarios registrados en la carpeta del revendedor
            for user in $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios); do
                info='===========================\n'
                # Obtiene la contrase√±a
                [[ -e /etc/SSHPlus/senha/$user ]] && senha=$(cat /etc/SSHPlus/senha/$user) || senha='Null'
                # Obtiene el l√≠mite de conexi√≥n
                [[ $(grep -wc $user $HOME/usuarios.db) != '0' ]] && limite=$(grep -w $user $HOME/usuarios.db | cut -d' ' -f2) || limite='Null'
                # Obtiene la fecha de expiraci√≥n
                datauser=$(chage -l $user | grep -i co | awk -F : '{print $2}')
                
                [[ $datauser = ' never' ]] && {
                    data="00/00/00"
                } || {
                    # Comprueba si la fecha ya expir√≥
                    databr="$(date -d "$datauser" +"%Y%m%d")"
                    hoje="$(date -d today +"%Y%m%d")"
                    [[ $hoje -ge $databr ]] && {
                        data="Vencido"
                    } || {
                        # Calcula los d√≠as restantes
                        dat="$(date -d"$datauser" '+%Y-%m-%d')"
                        data=$(echo -e "$((($(date -ud $dat +%s) - $(date -ud $(date +%Y-%m-%d) +%s)) / 86400)) D√çAS")
                    }
                }
                info+="$user ‚Ä¢ $senha ‚Ä¢ $limite ‚Ä¢ $data"
                echo -e "$info"
            done
        }
        fun_infu >$arq_info
        # Env√≠a la informaci√≥n al revendedor en bloques de 30 l√≠neas
        while :; do
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "$(while read linha; do echo $linha; done < <(sed '1,30!d' $arq_info))" \
                --parse_mode html
            sed -i 1,30d $arq_info
            [[ $(cat $arq_info | wc -l) = '0' ]] && rm $arq_info && break
        done
    # Acceso DENEGADO (ni administrador ni activo)
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}





fun_drop() {
    port_dropbear=$(ps aux | grep dropbear | awk NR==1 | awk '{print $17;}')
    log=/var/log/auth.log
    loginsukses='Password auth succeeded'
    pids=$(ps ax | grep dropbear | grep " $port_dropbear" | awk -F" " '{print $1}')
    for pid in $pids; do
        pidlogs=$(grep $pid $log | grep "$loginsukses" | awk -F" " '{print $3}')
        i=0
        for pidend in $pidlogs; do
            let i=i+1
        done
        if [ $pidend ]; then
            login=$(grep $pid $log | grep "$pidend" | grep "$loginsukses")
            PID=$pid
            user=$(echo $login | awk -F" " '{print $10}' | sed -r "s/'/ /g")
            waktu=$(echo $login | awk -F" " '{print $2"-"$1,$3}')
            # Formatea la columna de tiempo
            while [ ${#waktu} -lt 13 ]; do
                waktu=$waktu" "
            done
            # Formatea la columna de usuario
            while [ ${#user} -lt 16 ]; do
                user=$user" "
            done
            # Formatea la columna de PID
            while [ ${#PID} -lt 8 ]; do
                PID=$PID" "
            done
            echo "$user $PID $waktu"
        fi
    done
}

monitor_ssh() {
    # Si el usuario es el ADMINISTRADOR
    if [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        database="/root/usuarios.db"
        cad_onli=/tmp/$(echo $RANDOM)
        local info_on
        info_on='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_on+='<b>MONITOR DE USUARIOS EN L√çNEA</b>\n'
        info_on+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'
        info_on+='‚ö†Ô∏è Muestra en el formato de abajo:\n\n'
        info_on+='<code>USUARIO  EN L√çNEA/L√çMITE  TIEMPO\n</code>'
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e $info_on)" \
            --parse_mode html
        
        # Funci√≥n interna para obtener usuarios en l√≠nea (todos)
        fun_online() {
            local info2
            # Itera sobre todos los usuarios del sistema
            for user in $(cat /etc/passwd | awk -F : '$3 >= 1000 {print $1}' | grep -v nobody); do
                # Obtiene el l√≠mite
                [[ "$(grep -w $user $database)" != "0" ]] && lim="$(grep -w $user $database | cut -d' ' -f2)" || lim=0
                # Cuenta conexiones Dropbear
                [[ $(netstat -nltp | grep 'dropbear' | wc -l) != '0' ]] && drop="$(fun_drop | grep "$user" | wc -l)" || drop=0
                # Cuenta conexiones OpenVPN
                [[ -e /etc/openvpn/openvpn-status.log ]] && ovp="$(cat /etc/openvpn/openvpn-status.log | grep -E ,"$user", | wc -l)" || ovp=0
                # Cuenta conexiones SSH (sshd)
                sqd="$(ps -u $user | grep sshd | wc -l)"
                _cont=$(($drop + $ovp))
                conex=$(($_cont + $sqd)) # Total de conexiones
                
                # Si hay conexiones, muestra la informaci√≥n
                [[ $conex -gt '0' ]] && {
                    timerr="$(ps -o etime $(ps -u $user | grep sshd | awk 'NR==1 {print $1}') | awk 'NR==2 {print $1}')"
                    info2+="===========================\n"
                    info2+="üü¢ $user       $conex/$lim       ‚è≥$timerr\n"
                }
            done
            echo -e "$info2"
        }
        fun_online >$cad_onli
        # Env√≠a la lista al chat
        [[ $(cat $cad_onli | wc -w) != '0' ]] && {
            while :; do
                ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                    --text "$(while read linha; do echo $linha; done < <(sed '1,30!d' $cad_onli))" \
                    --parse_mode html
                sed -i 1,30d $cad_onli
                # Sale del bucle cuando no quedan m√°s l√≠neas
                [[ "$(cat $cad_onli | wc -l)" = '0' ]] && {
                    rm $cad_onli
                    break
                }
            done
        } || {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "Ning√∫n usuario en l√≠nea" \
                --parse_mode html
            return 0
        }
        
    # Si es un usuario ACTIVO (revendedor)
    elif [[ "$(grep -wc "${callback_query_from_username}" $ativos)" != '0' ]]; then
        # Verifica suspensi√≥n
        [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
            return 0
        }
        # Verifica si tiene usuarios creados
        [[ $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios | wc -l) == '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "¬°A√öN NO HAS CREADO NING√öN USUARIO!"
            return 0
        }
        
        database="/root/usuarios.db"
        cad_onli=/tmp/$(echo $RANDOM)
        local info_on
        info_on='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n'
        info_on+='<b>MONITOR DE USUARIOS EN L√çNEA</b>\n'
        info_on+='=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n'
        info_on+='‚ö†Ô∏è Muestra en el formato de abajo:\n\n'
        info_on+='<code>USUARIO  EN L√çNEA/L√çMITE  TIEMPO\n</code>'
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e $info_on)" \
            --parse_mode html
            
        # Funci√≥n interna para obtener usuarios en l√≠nea (solo los del revendedor)
        fun_online() {
            local info2
            for user in $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios); do
                # Obtiene el l√≠mite
                [[ "$(grep -w $user $database)" != "0" ]] && lim="$(grep -w $user $database | cut -d' ' -f2)" || lim=0
                # Cuenta conexiones Dropbear
                [[ $(netstat -nltp | grep 'dropbear' | wc -l) != '0' ]] && drop="$(fun_drop | grep "$user" | wc -l)" || drop=0
                # Cuenta conexiones OpenVPN
                [[ -e /etc/openvpn/openvpn-status.log ]] && ovp="$(cat /etc/openvpn/openvpn-status.log | grep -E ,"$user", | wc -l)" || ovp=0
                # Cuenta conexiones SSH (sshd)
                sqd="$(ps -u $user | grep sshd | wc -l)"
                conex=$(($sqd + $ovp + $drop)) # Total de conexiones
                
                # Si hay conexiones, muestra la informaci√≥n
                [[ $conex -gt '0' ]] && {
                    timerr="$(ps -o etime $(ps -u $user | grep sshd | awk 'NR==1 {print $1}') | awk 'NR==2 {print $1}')"
                    info2+="------------------------------\n"
                    info2+="üë§$user       $conex/$lim       ‚è≥$timerr\n"
                }
            done
            echo -e "$info2"
        }
        fun_online >$cad_onli
        # Env√≠a la lista al chat
        [[ $(cat $cad_onli | wc -w) != '0' ]] && {
            while :; do
                ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                    --text "<code>$(while read linha; do echo $linha; done < <(sed '1,30!d' $cad_onli))</code>" \
                    --parse_mode html
                sed -i 1,30d $cad_onli
                [[ "$(cat $cad_onli | wc -l)" = '0' ]] && {
                    rm $cad_onli
                    break
                }
            done
        } || {
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "Ning√∫n usuario en l√≠nea" \
                --parse_mode html
            return 0
        }
        
    # Acceso DENEGADO
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}

fun_verif_user() {
    user=$1
    
    # Verifica si el usuario fue proporcionado
    [[ -z "$user" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "Error: Ning√∫n usuario proporcionado.")" \
            --parse_mode html
        return 0
    }

    # Verifica si quien est√° ejecutando es el administrador
    if [[ "${message_from_id[$id]}" == "$id_admin" ]]; then
        # Verifica si el usuario existe en el sistema (UID >= 1000)
        if [[ "$(awk -F : '$3 >= 1000 { print $1 }' /etc/passwd | grep -wc $user)" == '0' ]]; then
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e ‚ùå ¬°Usuario $user no existe en el sistema!)" \
                --parse_mode html
            _erro='1'
            return 0
        fi
    else
        # Si no es administrador, verifica si el usuario existe en la reventa
        if [[ -d /etc/bot/revenda/${message_from_username} ]]; then
            if [[ ! -e /etc/bot/revenda/${message_from_username}/usuarios/$user ]]; then
                ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                    --text "$(echo -e ‚ùå ¬°Usuario $user no existe en la reventa!)" \
                    --parse_mode html
                _erro='1'
                return 0
            fi
        fi
    fi
}

fun_down() {
    # Solo el administrador puede acceder a esta funci√≥n
    [[ "${callback_query_from_id[$id]}" != "$id_admin" ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
    # Crea el directorio temporal si no existe
    [[ ! -d /tmp/file ]] && mkdir /tmp/file
    
    ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
        --text "[1] - A√ëADIR ARCHIVO\n[2] - ELIMINAR ARCHIVO\n\nIndica la opci√≥n [1-2]:" \
        --reply_markup "$(ShellBot.ForceReply)"
}

infovps() {
    # Solo el administrador puede acceder a esta funci√≥n
    [[ "${callback_query_from_id[$id]}" != "$id_admin" ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    }

    PTs='/tmp/prts'

    # Informaciones generales del sistema
    _ons=$(ps -x | grep sshd | grep -v root | grep priv | wc -l)
    [[ -e /etc/openvpn/openvpn-status.log ]] && _onop=$(grep -c "10.8.0" /etc/openvpn/openvpn-status.log) || _onop="0"
    [[ -e /etc/default/dropbear ]] && _drp=$(ps aux | grep dropbear | grep -v grep | wc -l) _ondrp=$(($_drp - 1)) || _ondrp="0"
    _on=$(($_ons + $_onop + $_ondrp)) # Total de conexiones SSH/Dropbear/OpenVPN
    total=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l) # Total de usuarios en el sistema
    system=$(cat /etc/issue.net)
    uso=$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')
    cpucores=$(grep -c cpu[0-9] /proc/stat)
    ram1=$(free -h | grep -i mem | awk {'print $2'})
    usoram=$(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')
    total=$(cat -n /root/usuarios.db | tail -n 1 | awk '{print $1}') # Total de usuarios en la base de datos

    # ================================
    # üîç LISTADO DE PUERTOS ACTIVOS
    # ================================
    echo "üîå <b>SERVICIOS EN EJECUCI√ìN</b>" > $PTs
    echo "" >> $PTs
    PT=$(lsof -V -i tcp -P -n 2>/dev/null | grep -v "ESTABLISHED" | grep -v "COMMAND" | grep "LISTEN")
    for porta in $(echo -e "$PT" | cut -d: -f2 | cut -d' ' -f1 | uniq); do
        svcs=$(echo -e "$PT" | grep -w "$porta" | awk '{print $1}' | uniq)
        echo -e "<b>$svcs</b> PUERTO <b>$porta</b>" >> $PTs
    done

    # ================================
    # üßæ MONTAR MENSAJE FINAL
    # ================================
    local info
    info="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
    info+="<b>INFORMACI√ìN DEL SERVIDOR</b>\n"
    info+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
    info+="<b>SISTEMA OPERATIVO</b>\n"
    info+="$system\n\n"
    info+="<b>PROCESADOR</b>\n"
    info+="N√∫cleos: <b>$cpucores</b>\n"
    info+="Utilizaci√≥n: <b>$uso</b>\n\n"
    info+="<b>MEMORIA RAM</b>\n"
    info+="Total: <b>$ram1</b>\n"
    info+="Uso: <b>$usoram</b>\n\n"

    while read linha; do
        info+="$(echo -e "$linha")\n"
    done < <(cat $PTs)

    info+="\n<b>$total</b> USUARIOS ‚Äî <b>$_on</b> EN L√çNEA"

    ShellBot.sendMessage --chat_id $id_admin \
        --text "$(echo -e "$info")" \
        --parse_mode html
    return 0
}

fun_download() {
    Opc=$1
    [[ -z "$Opc" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "‚ùåError, int√©ntalo de nuevo")"
        _erro='1'
        return 0
    }
    _file2=$2
    [[ -z "$_file2" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "‚ùåError, int√©ntalo de nuevo")"
        _erro='1'
        return 0
    }
    _DirArq=$(ls /etc/bot/arquivos)
    i=0
    unset _Pass
    # Itera sobre los archivos en /etc/bot/arquivos para crear una lista
    while read _Arq; do
        i=$(expr $i + 1)
        _oP=$i
        [[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
        echo -e "[$i] - $_Arq"
        _Pass+="\n${_oP}:${_Arq}"
    done <<<"${_DirArq}"
    # Selecciona el nombre del archivo basado en la opci√≥n (Opc)
    _file=$(echo -e "${_Pass}" | grep -E "\b$Opc\b" | cut -d: -f2)
    echo $_file2
    
    # Env√≠a el archivo de configuraci√≥n (.apk, .sh, etc.)
    ShellBot.sendDocument --chat_id ${message_from_id[$id]} \
        --document "@/etc/bot/arquivos/$_file" \
        --caption "$(echo -e "‚úÖ CREADO CON √âXITO ‚úÖ\n\nUSUARIO: <code>$(awk -F " " '/Nome/ {print $2}' $_file2)</code>\nCONTRASE√ëA: <code>$(awk -F " " '/Contrase√±a/ {print $2}' $_file2)</code>\nL√çMITE: $(awk -F " " '/Limite/ {print $2}' $_file2)\nEXPIRA EL: $(awk -F " " '/Validade/ {print $2}' $_file2)")" \
        --parse_mode html
        
    # Si existe el archivo OpenVPN (.ovpn), lo env√≠a tambi√©n
    [[ -e "/root/$(awk -F " " '/Nome/ {print $2}' $_file2).ovpn" ]] && {
        ShellBot.sendDocument --chat_id ${message_from_id[$id]} \
            --document "@/root/$(awk -F " " '/Nome/ {print $2}' $_file2).ovpn"
    }
}

otimizer() {
    # Solo el administrador puede acceder a esta funci√≥n
    [[ "${callback_query_from_id[$id]}" != "$id_admin" ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    }
    
    # Captura la utilizaci√≥n de memoria antes de optimizar
    MEM1=$(free | awk '/Mem:/ {print int(100*$3/$2)}')
    
    ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
        --text "üßπ LIMPIANDO CACH√â DEL SERVIDOR"
        
    # Comandos de optimizaci√≥n: limpieza de paquetes, liberaci√≥n de cach√© y swap
    apt-get autoclean -y
    echo 3 >/proc/sys/vm/drop_caches
    sync && sysctl -w vm.drop_caches=3 1>/dev/null 2>/dev/null
    sysctl -w vm.drop_caches=0 1>/dev/null 2>/dev/null
    swapoff -a
    swapon -a
    
    # Captura nueva informaci√≥n de memoria
    ram1=$(free -h | grep -i mem | awk {'print $2'}) # Total
    ram2=$(free -h | grep -i mem | awk {'print $3'}) # En uso
    ram3=$(free -h | grep -i mem | awk {'print $4'}) # Libre
    MEM2=$(free | awk '/Mem:/ {print int(100*$3/$2)}') # Utilizaci√≥n actual (%)
    res=$(expr $MEM1 - $MEM2) # Porcentaje de reducci√≥n
    
    local sucess
    sucess="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
    sucess+="<b>¬°OPTIMIZADO CON √âXITO!</b>\n"
    sucess+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
    sucess+="<i>Utilizaci√≥n anterior</i> $MEM1%\n\n"
    sucess+="<b>Memoria Ram Total</b> $ram1\n"
    sucess+="<b>Libre</b> $ram3\n"
    sucess+="<b>En uso</b> $ram2\n"
    sucess+="<i>Utilizaci√≥n actual</i> $MEM2%\n\n"
    sucess+="<b>Ahorro de:</b> $res%"
    
    ShellBot.sendMessage --chat_id $id_admin \
        --text "$(echo -e $sucess)" \
        --parse_mode html
    return 0
}

speed_test() {
    # Solo el administrador puede acceder a esta funci√≥n
    [[ "${callback_query_from_id[$id]}" != "$id_admin" ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    }
    
    # Limpia archivos anteriores y notifica el inicio
    rm -rf $HOME/speed >/dev/null 2>&1
    ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
        --text "üöÄ PROBANDO VELOCIDAD DEL SERVIDOR"
        
    # Ejecuta speedtest y guarda el resultado
    speedtest --share >speed
    
    # Extrae los valores del resultado
    png=$(cat speed | sed -n '5 p' | awk -F : {'print $NF'})
    down=$(cat speed | sed -n '7 p' | awk -F : {'print $NF'})
    upl=$(cat speed | sed -n '9 p' | awk -F : {'print $NF'})
    lnk=$(cat speed | sed -n '10 p' | awk {'print $NF'}) # Enlace al resultado
    
    local msg
    msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
    msg+="<b>üöÄ VELOCIDAD DEL SERVIDOR üöÄ</b>\n"
    msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
    msg+="<b>PING/LATENCIA:</b>$png\n"
    msg+="<b>DESCARGA (DOWNLOAD):</b>$down\n"
    msg+="<b>SUBIDA (UPLOAD):</b>$upl\n"
    
    # Env√≠a el resultado y el enlace
    ShellBot.sendMessage --chat_id $id_admin \
        --text "$(echo -e $msg)" \
        --parse_mode html
    ShellBot.sendMessage --chat_id $id_admin \
        --text "$(echo -e $lnk)" \
        --parse_mode html
        
    # Limpia archivos temporales
    rm -rf $HOME/speed >/dev/null 2>&1
    return 0
}

backup_users() {
    # Solo el administrador puede acceder a esta funci√≥n
    [[ "${callback_query_from_id[$id]}" != "$id_admin" ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "$(echo -e "üö´ ACCESO DENEGADO üö´")"
        return 0
    }

    ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
        --text "‚ôªÔ∏è CREANDO COPIA DE SEGURIDAD DE USUARIOS..."

    # Elimina el backup anterior
    rm -f /root/backup.vps 1>/dev/null 2>/dev/null

    # Crea el archivo tar con todos los archivos de configuraci√≥n
    tar cvf /root/backup.vps \
        /root/usuarios.db \
        /etc/shadow \
        /etc/passwd \
        /etc/group \
        /etc/gshadow \
        /etc/bot \
        /etc/SSHPlus/senha \
        /etc/bot/lista_ativos \
        /etc/bot/lista_suspensos \
        /etc/bot/arquivos/ \
        1>/dev/null 2>/dev/null

    # Env√≠a el archivo de backup al administrador
    ShellBot.sendDocument --chat_id ${id_admin} \
        --document "@/root/backup.vps" \
        --caption "$(echo -e "‚ôªÔ∏è COPIA DE SEGURIDAD DE USUARIOS, REVENDEDORES Y SUBS ‚ôªÔ∏è")"

    return 0
}

sobremim() {
    local msg
    msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
    msg+="<b>ü§ñ BOT ADMINISTRADOR DE VPS ü§ñ</b>\n"
    msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
    msg+="Fui creado con el prop√≥sito de proporcionar informaci√≥n y herramientas para la gesti√≥n de VPN en servidores üêß GNU/Linux üêß.\n\n"
    msg+="<b>Men√∫:</b> /menu\n"
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e $msg)" \
        --parse_mode html
    return 0
}

fun_add_teste() {
    if [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]]; then
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    elif [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üë§ CREAR PRUEBA (TEST) üë§\n\n¬øCu√°ntas horas debe durar? EJ: 1:" \
            --reply_markup "$(ShellBot.ForceReply)"
    elif [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]]; then
        # Es un revendedor
        _limTotal=$(grep -w "${callback_query_from_username}" $ativos | awk '{print $4}')
        fun_verif_limite_rev ${callback_query_from_username}
        # Verifica si crear la prueba (l√≠mite 1) excede su l√≠mite
        _limsomarev2=$(echo "$_result + 1" | bc)
        [[ "$_limsomarev2" -gt "$_limTotal" ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ùå ¬°NO TIENES L√çMITE DISPONIBLE!"
            return 0
        } || {
            # Si tiene l√≠mite, pide las horas
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "üë§ CREAR PRUEBA (TEST) üë§\n\n¬øCu√°ntas horas debe durar? EJ: 1:" \
                --reply_markup "$(ShellBot.ForceReply)"
        }
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    fi
}

fun_teste() {
    usuario=$(echo teste$((RANDOM % +500)))
    senha='1234'
    limite='1'
    t_time=$1 # Horas de duraci√≥n
    ex_date=$(date '+%d/%m/%C%y' -d " +2 days") # Fecha de expiraci√≥n (DD/MM/AAAA)
    tuserdate=$(date '+%C%y/%m/%d' -d " +2 days") # Fecha de expiraci√≥n para useradd (AAAA/MM/DD)
    
    # Manejo de errores si no se proporciona el tiempo
    [[ -z $t_time ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "‚ùå Error, int√©ntalo de nuevo")" \
            --parse_mode html
        return 0
        _erro='1'
    }
    
    # Crea el usuario en el sistema
    /usr/sbin/useradd -M -N -s /bin/false $usuario -e $tuserdate >/dev/null 2>&1
    (
        echo "$senha"
        echo "$senha"
    ) | passwd $usuario >/dev/null 2>&1
    echo "$senha" >/etc/SSHPlus/senha/$usuario
    echo "$usuario $limite" >>/root/usuarios.db
    
    # Registra el usuario si no es el administrador (en la carpeta del revendedor)
    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
        echo "$usuario:$senha:$ex_date:$limite" >/etc/bot/revenda/${message_from_username}/usuarios/$usuario
    }
    
    dir_teste="/etc/bot/revenda/${message_from_username}/usuarios/$usuario"
    
    # Crea el script de eliminaci√≥n autom√°tica (at)
    cat <<-EOF >/etc/SSHPlus/userteste/$usuario.sh
	#!/bin/bash
	# USUARIO PRUEBA (TEST)
	[[ \$(ps -u "$usuario" | grep -c sshd) != '0' ]] && pkill -u $usuario
	userdel --force $usuario
	grep -v ^$usuario[[:space:]] /root/usuarios.db > /tmp/ph ; cat /tmp/ph > /root/usuarios.db
	[[ -e $dir_teste ]] && rm $dir_teste
	rm /etc/SSHPlus/senha/$usuario > /dev/null 2>&1
	rm /etc/SSHPlus/userteste/$usuario.sh
	EOF
    
    # Programa la eliminaci√≥n autom√°tica
    chmod +x /etc/SSHPlus/userteste/$usuario.sh
    echo "/etc/SSHPlus/userteste/$usuario.sh" | at now + $t_time hour >/dev/null 2>&1
    
    # Define la unidad de tiempo para el mensaje
    [[ "$t_time" == '1' ]] && hrs="hora" || hrs="horas"
    
    # Env√≠a la informaci√≥n al usuario
    [[ "$(ls /etc/bot/arquivos | wc -l)" != '0' ]] && {
        # Si hay archivos, los env√≠a con la informaci√≥n de la cuenta
        for arqv in $(ls /etc/bot/arquivos); do
            ShellBot.sendDocument --chat_id ${message_from_id[$id]} \
                --document "@/etc/bot/arquivos/$arqv" \
                --caption "$(echo -e "‚úÖ CREADO CON √âXITO ‚úÖ\n\nUSUARIO: <code>$usuario</code>\nCONTRASE√ëA: <code>1234</code>\n\n‚è≥ Expira en: $t_time $hrs")" \
                --parse_mode html
        done
        return 0
    } || {
        # Si no hay archivos, env√≠a solo el texto
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "‚úÖ <b>CREADO CON √âXITO</b> ‚úÖ\n\nUSUARIO: <code>$usuario</code>\nCONTRASE√ëA: <code>1234</code>\n\n‚è≥ Expira en: $t_time $hrs")" \
            --parse_mode html
        return 0
    }
}

fun_exp_user() {
    # Si el usuario es el ADMINISTRADOR
    if [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        # Verifica si hay usuarios en la base de datos principal
        [[ $(cat /root/usuarios.db | wc -l) == '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "¬°A√öN NO HAS CREADO NING√öN USUARIO!"
            return 0
        }
        
        datenow=$(date +%s) # Tiempo actual en segundos
        
        # Itera sobre todos los usuarios SSH del sistema (UID >= 1000)
        for user in $(cat /etc/passwd | awk -F : '$3 >= 1000 {print $1}' | grep -v nobody); do
            expdate=$(chage -l $user | awk -F: '/Account expires/{print $2}') # Fecha de expiraci√≥n (texto)
            
            # Si la cuenta nunca expira, contin√∫a con el siguiente usuario
            echo $expdate | grep -q never && continue
            
            # Convierte la fecha de expiraci√≥n a segundos
            expsec=$(date +%s --date="$expdate")
            
            # Calcula la diferencia (Actual - Expiraci√≥n). Si es positivo o cero, ha expirado.
            diff=$(echo $datenow - $expsec | bc -l)
            
            # Si el resultado es negativo (empieza por -), el usuario a√∫n no expira.
            echo $diff | grep -q ^\- && continue
            
            # --- ELIMINACI√ìN DEL USUARIO EXPIRADO ---
            pkill -u $user # Finaliza las conexiones activas
            userdel --force $user # Elimina el usuario del sistema
            
            # Elimina el usuario de la base de datos principal
            grep -v ^$user[[:space:]] /root/usuarios.db >/tmp/ph
            cat /tmp/ph >/root/usuarios.db
            
            # Elimina archivos relacionados
            [[ -e /etc/bot/info-users/$user ]] && rm /etc/bot/info-users/$user
            [[ -e /etc/SSHPlus/userteste/$user.sh ]] && rm /etc/SSHPlus/userteste/$user.sh
            
            # Si existen revendedores, elimina el registro de sus carpetas
            [[ "$(ls /etc/bot/revenda)" != '0' ]] && {
                for ex in $(ls /etc/bot/revenda); do
                    [[ -e /etc/bot/revenda/$ex/usuarios/$user ]] && rm /etc/bot/revenda/$ex/usuarios/$user
                done
            }
        done
        
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚åõÔ∏è USUARIOS SSH EXPIRADOS ELIMINADOS"
        return 0
        
    # Si el usuario es un REVENDEDOR ACTIVO
    elif [[ "$(grep -wc "${callback_query_from_username}" $ativos)" != '0' ]]; then
        
        # Verifica suspensi√≥n del revendedor
        [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
            return 0
        }
        
        # Verifica si el revendedor ha creado usuarios
        [[ $(ls /etc/bot/revenda/${callback_query_from_username}/usuarios | wc -l) == '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "¬°A√öN NO HAS CREADO NING√öN USUARIO!"
            return 0
        }
        
        datenow=$(date +%s)
        dir_user="/etc/bot/revenda/${callback_query_from_username}/usuarios"
        
        # Itera solo sobre los usuarios creados por este revendedor
        for user in $(ls $dir_user); do
            expdate=$(chage -l $user | awk -F: '/Account expires/{print $2}')
            echo $expdate | grep -q never && continue
            expsec=$(date +%s --date="$expdate")
            diff=$(echo $datenow - $expsec | bc -l)
            echo $diff | grep -q ^\- && continue
            
            # --- ELIMINACI√ìN DEL USUARIO EXPIRADO ---
            pkill -f $user # Finaliza las conexiones activas
            userdel --force $user # Elimina el usuario del sistema
            
            # Elimina el usuario de la base de datos principal
            grep -v ^$user[[:space:]] /root/usuarios.db >/tmp/ph
            cat /tmp/ph >/root/usuarios.db
            
            # Elimina archivos relacionados
            [[ -e /etc/SSHPlus/userteste/$user.sh ]] && rm /etc/SSHPlus/userteste/$user.sh
            [[ -e "$dir_user/$user" ]] && rm $dir_user/$user # Elimina el registro de la carpeta del revendedor
        done
        
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚åõÔ∏è USUARIOS SSH EXPIRADOS ELIMINADOS"
        return 0
        
    # Acceso DENEGADO
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "$(echo -e üö´ ACCESO DENEGADO üö´)"
        return 0
    fi
}

relatorio_rev() {
    # Si el usuario es el ADMINISTRADOR
    if [[ "${callback_query_from_id[$id]}" = "$id_admin" ]]; then
        # 1. Recolecci√≥n de datos generales
        _ons=$(ps -x | grep sshd | grep -v root | grep priv | wc -l)
        _tuser=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
        [[ -e /etc/openvpn/openvpn-status.log ]] && _onop=$(grep -c "10.8.0" /etc/openvpn/openvpn-status.log) || _onop="0"
        [[ -e /etc/default/dropbear ]] && _drp=$(ps aux | grep dropbear | grep -v grep | wc -l) _ondrp=$(($_drp - 1)) || _ondrp="0"
        _onli=$(($_ons + $_onop + $_ondrp)) # Total online
        _cont_rev=$(echo $(grep -wc revenda $ativos) - $(grep -wc revenda $suspensos) | bc) # Revendedores activos (excluyendo suspendidos)
        _cont_sus=$(grep -wc revenda $suspensos) # Revendedores suspendidos
        _cont_sub=$(grep -wc subrevenda $ativos) # Sub-revendedores activos
        _cont_revt=$(grep -wc revenda $ativos) # Total de revendedores (activos)

        # 2. Montaje del mensaje inicial (resumen)
        local msg
        msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        msg+="<b>üìä REPORTE | INFORMACI√ìN GENERAL</b>\n"
        msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        msg+="<b>Usuarios totales:</b> $_tuser\n"
        msg+="<b>Usuarios en l√≠nea:</b> $_onli\n"
        msg+="<b>Revendedores Activos:</b> $_cont_rev\n"
        msg+="<b>Revendedores Suspendidos:</b> $_cont_sus\n"
        msg+="<b>Sub-Revendedores:</b> $_cont_sub\n\n"
        msg+="<b>Usuario:</b> @${callback_query_from_username}\n"
        msg+="<b>ID:</b> <code>${callback_query_from_id}</code>\n"

        # 3. Preparaci√≥n del informe detallado y verificaci√≥n de existencia
        [[ $_cont_revt != '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "üìä CREANDO REPORTE !"
        } || {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°NING√öN REVENDEDOR ENCONTRADO!"
            return 0
        }

        # Encabezado del archivo de reporte
        echo -e "REPORTE DE REVENDEDORES\n\nTotal: $_cont_revt  -  $(printf 'Fecha: %(%d/%m/%Y)T\n')\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=" >/tmp/Relatorio.txt

        # Itera sobre los revendedores activos (solo revendedores, no sub-revendedores)
        while read _revlist; do
            _nome_rev="$(echo $_revlist | awk '{print $2}')"
            _limite_rev="$(echo $_revlist | awk '{print $4}')"
            _data_rev="$(echo $_revlist | awk '{print $6}')"
            
            # Determina si est√° activo o suspendido
            [[ -e "/etc/bot/revenda/$_nome_rev/$_nome_rev" ]] && {
                _dirsts='revenda'
                _status='Activo'
            } || {
                _dirsts='suspensos'
                _status='Suspendido'
            }
            
            # Cuenta sub-revendedores bajo este revendedor
            _subrev="$(grep -wc SUBREVENDA /etc/bot/$_dirsts/$_nome_rev/$_nome_rev)"

            # Funci√≥n para contar conexiones por usuario (copiada de monitor_ssh)
            fun_on() {
                for user in $(ls /etc/bot/$_dirsts/$_nome_rev/usuarios); do
                    [[ $(netstat -nltp | grep 'dropbear' | wc -l) != '0' ]] && drop="$(fun_drop | grep "$user" | wc -l)" || drop=0
                    [[ -e /etc/openvpn/openvpn-status.log ]] && ovp="$(cat /etc/openvpn/openvpn-status.log | grep -E ,"$user", | wc -l)" || ovp=0
                    sqd="$(ps -u $user | grep sshd | wc -l)"
                    conex=$(($sqd + $ovp + $drop))
                    echo -e "$conex"
                done
            }
            
            # Calcula el total de usuarios creados y en l√≠nea por el revendedor
            [[ "$(ls /etc/bot/$_dirsts/$_nome_rev/usuarios | wc -l)" != '0' ]] && {
                total_on=$(fun_on | paste -s -d + | bc)
                total_users=$(ls /etc/bot/$_dirsts/$_nome_rev/usuarios | wc -l)
            } || {
                total_on='0'
                total_users='0'
            }
            
            # Escribe la informaci√≥n en el archivo
            echo -e "\nESTADO: $_status\nREVENDEDOR: @$_nome_rev\nL√çMITE: $_limite_rev\nD√çAS RESTANTES: $_data_rev\nSSH CREADAS: $total_users\nSSH EN L√çNEA: $total_on\nSUB-REVENDEDORES: $_subrev\n\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=" >>/tmp/Relatorio.txt
        done <<<"$(grep -w 'revenda' $ativos)"
        
        # 4. Env√≠o del documento
        ShellBot.sendDocument --chat_id $id_admin \
            --document "@/tmp/Relatorio.txt" \
            --caption "$(echo -e "$msg")" \
            --parse_mode html
        return 0

    # Si el usuario es un REVENDEDOR ACTIVO
    elif [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]]; then
        
        # Verifica suspensi√≥n
        [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
            return 0
        }
        
        # --- CASO 1: EL REVENDEDOR NO TIENE SUB-REVENDEDORES ---
        [[ $(grep -wc 'SUBREVENDA' /etc/bot/revenda/${callback_query_from_username}/${callback_query_from_username}) == '0' ]] && {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ö†Ô∏è ¬°NING√öN SUB-REVENDEDOR ENCONTRADO!"
                
            # Muestra solo la informaci√≥n de l√≠mite del propio revendedor
            _cont_limite=$(grep -w ${callback_query_from_username} $ativos | awk '{print $4}')
            fun_verif_limite_rev ${callback_query_from_username}
            _cont_disp=$(echo $_cont_limite - $_result | bc)
            local msg
            msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
            msg+="<b>üìä REPORTE | INFORMACI√ìN</b>\n"
            msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
            msg+="<b>L√≠mite de Logins:</b> $_cont_limite\n"
            msg+="<b>L√≠mite Disponible:</b> $_cont_disp\n"
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "$msg" \
                --parse_mode html
            return 0
        }

        # --- CASO 2: EL REVENDEDOR TIENE SUB-REVENDEDORES ---

        # Funci√≥n para contar sub-revendedores suspendidos
        fun_contsub() {
            while read _sublist; do
                _usub="$(echo $_sublist | awk '{print $2}')"
                # Devuelve 1 si est√° suspendido, 0 si no
                echo $(grep -wc $_usub $suspensos)
            done <<<"$(grep -w 'SUBREVENDA' /etc/bot/revenda/${callback_query_from_username}/${callback_query_from_username})"
        }
        
        # 1. Recolecci√≥n de datos del revendedor principal
        _cont_limite=$(grep -w ${callback_query_from_username} $ativos | awk '{print $4}')
        fun_verif_limite_rev ${callback_query_from_username}
        _cont_disp=$(echo $_cont_limite - $_result | bc)
        _cont_atv=$(grep -wc SUBREVENDA /etc/bot/revenda/${callback_query_from_username}/${callback_query_from_username})
        _cont_sup=$(fun_contsub | paste -s -d + | bc) # Suma el total de sub-revendedores suspendidos

        # 2. Montaje del mensaje inicial (resumen)
        local msg
        msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        msg+="<b>üìä REPORTE | INFORMACI√ìN</b>\n"
        msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        msg+="<b>L√≠mite de Logins:</b> $_cont_limite\n"
        msg+="<b>L√≠mite Disponible:</b> $_cont_disp\n"
        msg+="<b>Sub-Revendedores Total:</b> $_cont_atv\n"
        msg+="<b>Sub-Revendedores Suspendidos:</b> $_cont_sup\n"
        msg+="<b>Usuario:</b> @${callback_query_from_username}\n"
        msg+="<b>ID:</b> <code>${callback_query_from_id}</code>\n"
        
        # 3. Preparaci√≥n del informe detallado de sub-revendedores
        echo -e "REPORTE DE SUB-REVENDEDORES\n\nTotal: $_cont_atv  -  $(printf 'Fecha: %(%d/%m/%Y)T\n')\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=" >/tmp/Relatorio-${callback_query_from_username}.txt

        # Itera sobre los sub-revendedores del usuario actual
        while read _sublist; do
            _usub="$(echo $_sublist | awk '{print $2}')"
            _limit_sub=$(echo $_sublist | awk '{print $4}')
            _data_sub=$(grep -w $_usub $ativos | awk '{print $6}')
            
            # Determina si est√° activo o suspendido
            [[ -e "/etc/bot/revenda/$_usub/$_usub" ]] && {
                _dirsts='revenda'
                _status='Activo'
            } || {
                _dirsts='suspensos'
                _status='Suspendido'
            }
            
            # Funci√≥n para contar conexiones por usuario (espec√≠fico para sub-revendedores)
            fun_subon() {
                for user in $(ls /etc/bot/$_dirsts/$_usub/usuarios); do
                    [[ $(netstat -nltp | grep 'dropbear' | wc -l) != '0' ]] && drop="$(fun_drop | grep "$user" | wc -l)" || drop=0
                    [[ -e /etc/openvpn/openvpn-status.log ]] && ovp="$(cat /etc/openvpn/openvpn-status.log | grep -E ,"$user", | wc -l)" || ovp=0
                    sqd="$(ps -u $user | grep sshd | wc -l)"
                    conex=$(($sqd + $ovp + $drop))
                    echo -e "$conex"
                done
            }
            
            # Calcula el total de usuarios creados y en l√≠nea por el sub-revendedor
            [[ "$(ls /etc/bot/$_dirsts/$_usub/usuarios | wc -l)" != '0' ]] && {
                # Se corrige la llamada de fun_on a fun_subon o se asegura que fun_on est√© definido
                # Aqu√≠ se asume que fun_on no existe y usamos fun_subon para contar
                total_on=$(fun_subon | paste -s -d + | bc)
                total_users=$(ls /etc/bot/$_dirsts/$_usub/usuarios | wc -l)
            } || {
                total_on='0'
                total_users='0'
            }
            
            # Escribe la informaci√≥n en el archivo
            echo -e "\nESTADO: $_status\nSUB-REVENDEDOR: @$_usub\nL√çMITE: $_limit_sub\nD√çAS RESTANTES: $_data_sub\nSSH CREADAS: $total_users\nSSH EN L√çNEA: $total_on\n\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=" >>/tmp/Relatorio-${callback_query_from_username}.txt
        done <<<"$(grep -w 'SUBREVENDA' /etc/bot/revenda/${callback_query_from_username}/${callback_query_from_username})"
        
        # 4. Env√≠o del documento
        ShellBot.sendDocument --chat_id ${callback_query_message_chat_id[$id]} \
            --document "@/tmp/Relatorio-${callback_query_from_username}.txt" \
            --caption "$(echo -e "$msg")" \
            --parse_mode html
        return 0

    # Si no es administrador ni revendedor activo
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    fi
}

fun_backauto() {
    # Solo el administrador puede acceder a esta funci√≥n
    [[ "${callback_query_from_id[$id]}" = "$id_admin" ]] && {
        
        # Si el directorio de backups NO existe (es la primera vez o est√° desactivado)
        [[ ! -d /etc/SSHPlus/backups ]] && {
            mkdir /etc/SSHPlus/backups
            # A√±ade la tarea de backup al cron (si no existe ya)
            [[ $(crontab -l | grep -c "userbackup") = '0' ]] && (
                crontab -l 2>/dev/null
                echo "0 */6 * * * /bin/userbackup 1" # Ejecuta userbackup cada 6 horas
            ) | crontab -
            s # El 's' aqu√≠ parece ser un error de script o un comando no est√°ndar. Asumo que es un error tipogr√°fico.
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ôªÔ∏è BACKUP AUTOM√ÅTICO ACTIVADO üü¢"
            return 0
            
        } || {
            # Si el directorio de backups S√ç existe (est√° activado), lo desactiva
            # Elimina la tarea del cron
            [[ $(crontab -l | grep -c "userbackup") != '0' ]] && crontab -l | grep -v 'userbackup' | crontab -
            # Elimina el directorio de backups
            [[ -d /etc/SSHPlus/backups ]] && rm -rf /etc/SSHPlus/backups
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "‚ôªÔ∏è BACKUP AUTOM√ÅTICO DESACTIVADO üî¥"
            return 0
        }
    }
}

backup_auto() {
    # Env√≠a el archivo de backup autom√°tico al administrador
    ShellBot.sendDocument --chat_id $id_admin \
        --document "@/etc/SSHPlus/backups/backup.vps" \
        --caption "$(echo -e "‚ôªÔ∏è BACKUP AUTOM√ÅTICO ‚ôªÔ∏è")"
    # Elimina el archivo despu√©s de enviarlo
    rm /etc/SSHPlus/backups/backup.vps
    return 0
}

restaure_backup() {
    # Solo el administrador puede restaurar
    [[ ${message_from_id[$id]} == ${id_admin} ]] && {
        # Verifica que el nombre del archivo sea exactamente 'backup.vps'
        [[ "${message_document_file_name}" != 'backup.vps' ]] && return 0
        local file_id
        file_id=${message_document_file_id[$id]}
        if [[ $file_id ]]; then
            # Limpia archivos temporales anteriores
            [[ -e /tmp/backup.vps ]] && rm /tmp/backup.vps
            [[ "$(ls /tmp | grep -c '.vps')" != '0' ]] && {
                for i in $(ls /tmp | grep '.vps'); do
                    rm /tmp/$i
                done
            }
            # Descarga el archivo
            ShellBot.getFile --file_id $file_id
            if ShellBot.downloadFile --file_path "${return[file_path]}" --dir "/tmp"; then
                msg='<b>‚ôªÔ∏è ARCHIVO DE COPIA DE SEGURIDAD ‚ôªÔ∏è</b>\n\n<i>¬°El archivo enviado es un archivo\nde copia de seguridad de usuarios!</i>'
                ShellBot.sendMessage --chat_id ${id_admin} \
                    --text "$(echo -e "$msg")" \
                    --parse_mode html
                # Pide confirmaci√≥n para restaurar
                ShellBot.sendMessage --chat_id ${id_admin} \
                    --text '¬øDesea restaurar? [si | no]' \
                    --reply_markup "$(ShellBot.ForceReply)"
            fi
        fi
        return 0
    }
}

msg_bot() {
    local msg
    msg="ü§ñ \n\n" # El cuerpo est√° vac√≠o, solo el emoji.
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e $msg)" \
        --parse_mode html
    return 0
}

msg_bem_vindo() {
    local msg
    msg="‚úåÔ∏èüòÉ Hola <b>${message_from_first_name[$id]}</b>\n\nBIENVENIDO(a)\n\n"
    msg+="Para acceder al men√∫\nhaz clic o ejecuta [ /menu ]\n\n"
    msg+="Para obtener informaci√≥n\nhaz clic o ejecuta [ /ayuda ]\n\n"
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e $msg)" \
        --parse_mode html
    return 0
}

fun_verif_limite_rev() {
    _userrev=$1 # Nombre de usuario del revendedor/sub-revendedor
    
    # Si es un REVENDEDOR
    [[ "$(grep -w "$_userrev" $ativos | awk '{print $NF}')" == 'revenda' ]] && {
        echo $_userrev
        
        # Suma los l√≠mites de todos sus SUB-REVENDEDORES
        [[ $(grep -wc 'SUBREVENDA' /etc/bot/revenda/$_userrev/$_userrev) != '0' ]] && {
            _limsomarev=$(grep -w 'SUBREVENDA' /etc/bot/revenda/$_userrev/$_userrev | awk {'print $4'} | paste -s -d + | bc)
        } || {
            _limsomarev='0'
        }
        
        # Suma los l√≠mites de los USUARIOS creados directamente por el REVENDEDOR
        [[ $(ls /etc/bot/revenda/$_userrev/usuarios | wc -l) != '0' ]] && {
            _mlim1='0'
            _meus_users="/etc/bot/revenda/$_userrev/usuarios"
            for _user_ in $(ls $_meus_users); do
                _mlim2=$(cat $_meus_users/$_user_ | awk -F : {'print $4'}) # L√≠mite del usuario
                _mlim1=$(echo "${_mlim1} + ${_mlim2}" | bc)
            done
        }
        
        [[ -z "$_mlim1" ]] && _mlim1='0'
        
        # Resultado final: L√≠mite usado por Sub-revendedores + L√≠mite usado por usuarios propios
        _result=$(echo "${_limsomarev} + ${_mlim1}" | bc)
    }
    
    # Si es un SUB-REVENDEDOR
    [[ "$(grep -w "$_userrev" $ativos | awk '{print $NF}')" == 'subrevenda' ]] && {
        
        # Suma los l√≠mites de los USUARIOS creados directamente por el SUB-REVENDEDOR
        [[ "$(ls /etc/bot/revenda/$_userrev/usuarios | wc -l)" != '0' ]] && {
            _dir_users="/etc/bot/revenda/$_userrev/usuarios"
            _lim1='0'
            for i in $(ls $_dir_users); do
                _lim2=$(cat $_dir_users/$i | awk -F : {'print $4'}) # L√≠mite del usuario
                _lim1=$(echo "${_lim1} + ${_lim2}" | bc)
            done
        }
        
        [[ -z "$_lim1" ]] && _lim1='0'
        
        # Resultado final: L√≠mite usado por usuarios propios
        _result=$(echo "${_lim1}")
    }
}

fun_add_revenda() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Solo el administrador o un revendedor activo pueden a√±adir
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üë• A√ëADIR REVENDEDOR üë•\n\nIndica el nombre:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

criar_rev() {
    file_rev=$1
    [[ -z "$file_rev" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e Error)"
        _erro='1'
        break # Esto es peligroso fuera de un bucle, asumo que es un error original del script.
    }
    
    # Extrae los datos del archivo temporal generado por el bot
    n_rev=$(sed -n '1 p' $file_rev | cut -d' ' -f2) # Nombre
    u_rev=$(sed -n '2 p' $file_rev | awk -F '@' {'print $2'}) # Username (sin @)
    l_rev=$(sed -n '3 p' $file_rev | cut -d' ' -f2) # L√≠mite
    d_rev=$(sed -n '4 p' $file_rev | cut -d' ' -f2) # D√≠as
    
    # Determina si es un Revendedor o Sub-revendedor
    [[ "${message_from_id[$id]}" = "$id_admin" ]] && {
        t_rev='revenda'
    } || {
        t_rev='subrevenda'
        # Si es sub-revendedor, registra en el archivo del revendedor principal
        echo -e "SUBREVENDA: $u_rev LIMITE_SUBREVENDA: $l_rev" >>/etc/bot/revenda/${message_from_username}/${message_from_username}
    }
    
    # Crea la estructura de directorios
    mkdir /etc/bot/revenda/"$u_rev"
    mkdir /etc/bot/revenda/"$u_rev"/usuarios
    touch /etc/bot/revenda/"$u_rev"/$u_rev
    
    # Registra en la lista de activos
    echo -e "USER: $u_rev LIMITE: $l_rev DIAS: $d_rev TIPO: $t_rev" >>$ativos
    
    # Escribe la informaci√≥n de l√≠mite en el archivo de control del revendedor
    echo -e "=========================\nLIMITE_REVENDA: $l_rev\nDIAS_REVENDA: $d_rev\n=========================\n" >/etc/bot/revenda/"$u_rev"/$u_rev
    
    # Agrega la fecha de vencimiento al archivo temporal para el mensaje de confirmaci√≥n
    sed -i '$d' $file_rev # Elimina la √∫ltima l√≠nea (que asumo es temporal)
    echo -e "Vencimiento: $(date "+%d/%m/%Y" -d "+$d_rev days")" >>$file_rev
}

fun_del_rev() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Solo el administrador o un revendedor activo pueden eliminar
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üóë ELIMINAR REVENDEDOR üóë\n\nIndica su usuario [Ej: @Nombre Del Usuario]:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

del_rev() {
    _cli_rev=$1 # Username del revendedor/sub-revendedor a eliminar
    [[ -z "$_cli_rev" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "Error")"
        return 0
    }
    
    # --- L√ìGICA DEL ADMINISTRADOR ---
    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
        [[ "$(grep -wc "$_cli_rev" $ativos)" != '0' ]] && {
            
            # 1. Determina si el revendedor est√° activo o suspendido
            [[ -e "/etc/bot/revenda/$_cli_rev/$_cli_rev" ]] && _dirsts='revenda' || _dirsts='suspensos'
            
            # 2. Si el revendedor tiene SUB-REVENDEDORES, los elimina primero
            [[ "$(grep -wc 'SUBREVENDA' /etc/bot/$_dirsts/$_cli_rev/$_cli_rev)" != '0' ]] && {
                while read _listsub2; do
                    _usub="$(echo $_listsub2 | awk '{print $2}')" # Sub-revendedor
                    [[ -e "/etc/bot/revenda/$_usub/$_usub" ]] && _dirsts2='revenda' || _dirsts2='suspensos'
                    _dir_users="/etc/bot/$_dirsts2/$_usub/usuarios"
                    
                    # Elimina los usuarios creados por el sub-revendedor
                    [[ "$(ls $_dir_users | wc -l)" != '0' ]] && {
                        for _user in $(ls $_dir_users); do
                            piduser=$(ps -u "$_user" | grep sshd | cut -d? -f1)
                            kill -9 $piduser >/dev/null 2>&1 # Mata sesiones activas
                            userdel --force "$_user" 2>/dev/null # Elimina usuario SSH
                            grep -v ^$_user[[:space:]] /root/usuarios.db >/tmp/ph; cat /tmp/ph >/root/usuarios.db # Elimina de la DB
                            rm /etc/bot/info-users/$_user # Elimina info
                        done
                    }
                    # Elimina la carpeta del sub-revendedor y lo remueve de las listas
                    [[ -d /etc/bot/$_dirsts2/$_usub ]] && rm -rf /etc/bot/$_dirsts2/$_usub >/dev/null 2>&1
                    sed -i "/\b$_usub\b/d" $ativos
                    [[ $(grep -wc "$_usub" $suspensos) != '0' ]] && { sed -i "/\b$_usub\b/d" $suspensos; }
                done <<<"$(grep -w 'SUBREVENDA' /etc/bot/$_dirsts/$_cli_rev/$_cli_rev)"
            }
            
            # 3. Elimina los usuarios creados directamente por el REVENDEDOR
            [[ "$(ls /etc/bot/$_dirsts/$_cli_rev/usuarios | wc -l)" != '0' ]] && {
                for _user in $(ls /etc/bot/$_dirsts/$_cli_rev/usuarios); do
                    piduser=$(ps -u "$_user" | grep sshd | cut -d? -f1)
                    kill -9 $piduser >/dev/null 2>&1
                    userdel --force "$_user" 2>/dev/null
                    grep -v ^$_user[[:space:]] /root/usuarios.db >/tmp/ph; cat /tmp/ph >/root/usuarios.db
                    rm /etc/bot/info-users/$_user
                done
            }
            
            # 4. Elimina la carpeta del REVENDEDOR y lo remueve de las listas
            [[ -d /etc/bot/$_dirsts/$_cli_rev ]] && rm -rf /etc/bot/$_dirsts/$_cli_rev >/dev/null 2>&1
            sed -i "/\b$_cli_rev\b/d" $ativos
            [[ $(grep -wc "$_cli_rev" $suspensos) != '0' ]] && { sed -i "/\b$_cli_rev\b/d" $suspensos; }
            
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "ELIMINADO CON √âXITO")" \
                --parse_mode html
            return 0
        } || {
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e ‚ùå ¬°REVENDEDOR NO EXISTE! ‚ùå)"
            return 0
        }
    } 
    # --- L√ìGICA DEL REVENDEDOR (eliminando solo sus sub-revendedores) ---
    || { 
        # Verifica si el sub-revendedor pertenece a este revendedor principal
        [[ "$(grep -wc "$_cli_rev" /etc/bot/revenda/${message_from_username}/${message_from_username})" != '0' ]] && {
            
            # Caso 1: El sub-revendedor est√° activo
            [[ -d /etc/bot/revenda/$_cli_rev ]] && {
                # Elimina usuarios del sub-revendedor
                [[ "$(ls /etc/bot/revenda/$_cli_rev/usuarios | wc -l)" != '0' ]] && {
                    for _user in $(ls /etc/bot/revenda/$_cli_rev/usuarios); do
                        piduser=$(ps -u "$_user" | grep sshd | cut -d? -f1)
                        kill -9 $piduser >/dev/null 2>&1
                        userdel --force "$_user" 2>/dev/null
                        grep -v ^$_user[[:space:]] /root/usuarios.db >/tmp/ph; cat /tmp/ph >/root/usuarios.db
                        rm /etc/bot/info-users/$_user
                    done
                }
                # Elimina la carpeta y registros
                [[ -d /etc/bot/revenda/$_cli_rev ]] && rm -rf /etc/bot/revenda/$_cli_rev >/dev/null 2>&1
                sed -i "/\b$_cli_rev\b/d" $ativos
                sed -i "/\b$_cli_rev\b/d" /etc/bot/revenda/${message_from_username}/${message_from_username} # Elimina del registro del revendedor principal
            }
            
            # Caso 2: El sub-revendedor est√° suspendido
            [[ -d /etc/bot/suspensos/$_cli_rev ]] && {
                # Elimina usuarios del sub-revendedor
                [[ "$(ls /etc/bot/suspensos/$_cli_rev/usuarios | wc -l)" != '0' ]] && {
                    for _user in $(ls /etc/bot/suspensos/$_cli_rev/usuarios); do
                        piduser=$(ps -u "$_user" | grep sshd | cut -d? -f1)
                        kill -9 $piduser >/dev/null 2>&1
                        userdel --force "$_user" 2>/dev/null
                        grep -v ^$_user[[:space:]] /root/usuarios.db >/tmp/ph; cat /tmp/ph >/root/usuarios.db
                        rm /etc/bot/info-users/$_user
                    done
                }
                # Elimina la carpeta y registros
                [[ -d /etc/bot/suspensos/$_cli_rev ]] && rm -rf /etc/bot/suspensos/$_cli_rev >/dev/null 2>&1
                sed -i "/\b$_cli_rev\b/d" $ativos
                sed -i "/\b$_cli_rev\b/d" $suspensos
                sed -i "/\b$_cli_rev\b/d" /etc/bot/revenda/${message_from_username}/${message_from_username} # Elimina del registro del revendedor principal
            }
            
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "ELIMINADO CON √âXITO")" \
                --parse_mode html
            return 0
        } || {
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e ‚ùå ¬°REVENDEDOR NO EXISTE! ‚ùå)"
            return 0
        }
    }
}

fun_lim_rev() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Solo el administrador o un revendedor activo pueden acceder
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "‚ôæ MODIFICAR L√çMITE DE REVENTA ‚ôæ\n\nIndica su usuario [Ej: @Nombre Del Usuario]:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

lim_rev() {
    _file_lim=$1
    [[ -z "$_file_lim" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "Error")"
        return 0
    }
    
    _rev_usern=$(grep -w 'Revendedor' $_file_lim | awk -F '@' {'print $2'})
    new_l=$(grep -w 'Limite' $_file_lim | awk {'print $2'})
    
    # Si el revendedor est√° ACTIVO
    [[ -d /etc/bot/revenda/$_rev_usern ]] && {
        l_old=$(grep -w 'LIMITE_REVENDA' /etc/bot/revenda/$_rev_usern/$_rev_usern | awk {'print $2'})
        
        # Actualiza el l√≠mite en el archivo de control del revendedor
        sed -i "/LIMITE_REVENDA/ s/$l_old/$new_l/g" /etc/bot/revenda/$_rev_usern/$_rev_usern
        # Actualiza el l√≠mite en la lista de activos
        sed -i "/$_rev_usern/ s/LIMITE: $l_old/LIMITE: $new_l/" $ativos
        
        # Si no es el administrador, actualiza el registro en el archivo del revendedor principal
        [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
            sed -i "/\b$_rev_usern\b/ s/$l_old/$new_l/g" /etc/bot/revenda/${message_from_username}/${message_from_username}
        }
        echo $_rev_usern
        
    # Si el revendedor est√° SUSPENDIDO
    } || {
        l_old=$(grep -w 'LIMITE_REVENDA' /etc/bot/suspensos/$_rev_usern/$_rev_usern | awk {'print $2'})
        
        # Actualiza el l√≠mite en el archivo de control del revendedor (suspendido)
        sed -i "/LIMITE_REVENDA/ s/$l_old/$new_l/g" /etc/bot/suspensos/$_rev_usern/$_rev_usern
        # Actualiza el l√≠mite en la lista de activos (aunque est√© suspendido, el registro est√° ah√≠)
        sed -i "/\b$_rev_usern\b/ s/LIMITE: $l_old/LIMITE: $new_l/" $ativos
        # Actualiza el l√≠mite en la lista de suspendidos
        sed -i "/\b$_rev_usern\b/ s/LIMITE: $l_old/LIMITE: $new_l/" $suspensos
        
        # Si no es el administrador, actualiza el registro en el archivo del revendedor principal
        [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
            sed -i "/\b$_rev_usern\b/ s/$l_old/$new_l/" /etc/bot/revenda/${message_from_username}/${message_from_username}
        }
        echo $_rev_usern
    }
}

fun_dat_rev() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Solo el administrador o un revendedor activo pueden acceder
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üìÜ MODIFICAR FECHA DE REVENTA üìÜ\n\nIndica su usuario [Ej: @Nombre Del Usuario]:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

dat_rev() {
    _datfile=$1
    [[ -z "$_datfile" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "Error")"
        _erro='1'
        return 0
    }
    
    _revd=$(grep -w 'Revendedor' $_datfile | cut -d'@' -f2)
    new_d=$(grep -w 'Data' $_datfile | awk '{print $NF}') # Nuevos d√≠as de duraci√≥n
    
    # Si el revendedor est√° SUSPENDIDO (se reactivar√°)
    [[ -d "/etc/bot/suspensos/$_revd" ]] && {
        
        # 1. Desuspende los usuarios SSH del revendedor
        [[ "$(ls /etc/bot/suspensos/$_revd/usuarios | wc -l)" != '0' ]] && {
            for _user in $(ls /etc/bot/suspensos/$_revd/usuarios); do
                usermod -U $_user # Desbloquea el usuario SSH
            done
        }
        
        # 2. Actualiza los d√≠as en los archivos de control y lista de activos
        d_old=$(grep -w 'DIAS_REVENDA' /etc/bot/suspensos/$_revd/$_revd | awk {'print $2'})
        sed -i "/\b$_revd\b/ s/DIAS: $d_old/DIAS: $new_d/" $ativos
        sed -i "/DIAS_REVENDA/ s/$d_old/$new_d/" /etc/bot/suspensos/$_revd/$_revd
        
        # 3. Mueve y desuspende a los SUB-REVENDEDORES del revendedor principal
        [[ "$(grep -wc 'SUBREVENDA' /etc/bot/suspensos/$_revd/$_revd)" != '0' ]] && {
            while read _listsub; do
                _usub="$(echo $_listsub | awk '{print $2}')"
                
                # Desuspende los usuarios SSH de cada sub-revendedor
                [[ "$(ls /etc/bot/suspensos/$_usub/usuarios | wc -l)" != '0' ]] && {
                    for _user in $(ls /etc/bot/suspensos/$_usub/usuarios); do
                        usermod -U $_user
                    done
                }
                mv /etc/bot/suspensos/$_usub /etc/bot/revenda/$_usub # Mueve la carpeta
                sed -i "/\b$_usub\b/d" $suspensos # Elimina de la lista de suspendidos
            done <<<"$(grep -w 'SUBREVENDA' /etc/bot/suspensos/$_revd/$_revd)"
        }
        
        # 4. Mueve al revendedor principal y lo desuspende
        mv /etc/bot/suspensos/$_revd /etc/bot/revenda/$_revd
        sed -i "/\b$_revd\b/d" $suspensos
        
        # 5. Env√≠a confirmaci√≥n
        sed -i "s;$new_d;$(date "+%d/%m/%Y" -d "+$new_d days");" $_datfile # Actualiza el archivo temporal para el mensaje final
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "‚ö†Ô∏è $_revd ESTABA SUSPENDIDO Y FUE REACTIVADO !")" \
            --parse_mode html
            
    # Si el revendedor est√° ACTIVO (solo extiende la fecha)
    } || {
        d_old=$(grep -w 'DIAS_REVENDA' /etc/bot/revenda/$_revd/$_revd | awk {'print $2'})
        
        # Actualiza los d√≠as en la lista de activos
        sed -i "/\b$_revd\b/ s/DIAS: $d_old/DIAS: $new_d/" $ativos
        # Actualiza los d√≠as en el archivo de control del revendedor
        sed -i "/DIAS_REVENDA/ s/$d_old/$new_d/" /etc/bot/revenda/$_revd/$_revd
        
        # Actualiza el archivo temporal para el mensaje final (muestra la nueva fecha de vencimiento)
        sed -i "s;$new_d;$(date "+%d/%m/%Y" -d "+$new_d days");" $_datfile
    }
}

fun_list_rev() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    
    # --- L√ìGICA DEL ADMINISTRADOR ---
    if [[ "${callback_query_from_id[$id]}" == "$id_admin" ]]; then
        local msg1
        msg1="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\nüìÉ LISTA DE REVENDEDORES\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        
        # Si existen revendedores activos
        [[ "$(grep -wc 'revenda' $ativos)" != '0' ]] && {
            while read _atvs; do
                _uativ="$(echo $_atvs | awk '{print $2}')" # Nombre de usuario del revendedor
                # Verifica si el revendedor est√° en la lista de suspendidos
                [[ "$(grep -wc "$_uativ" $suspensos)" == '0' ]] && _stsrev='ACTIVO' || _stsrev='SUSPENDIDO'
                msg1+="‚Ä¢ @$_uativ - $_stsrev\n"
            done <<<"$(grep -w 'revenda' /etc/bot/lista_ativos)" # Lee la lista de activos
            
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "$(echo -e "$msg1")" \
                --parse_mode html
            return 0
        } || {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "NO TIENES REVENDEDORES"
            return 0
        }
        
    # --- L√ìGICA DEL REVENDEDOR (Mostrar Sub-revendedores) ---
    elif [[ "$(grep -w ${callback_query_from_username} $ativos | awk '{print $NF}')" == 'revenda' ]]; then
        _patch="/etc/bot/revenda"
        local msg1
        msg1="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\nüìÉ LISTA DE SUB-REVENDEDORES\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        
        # Si el revendedor tiene sub-revendedores registrados
        [[ "$(grep -wc "SUBREVENDA" $_patch/${callback_query_from_username}/${callback_query_from_username})" != '0' ]] && {
            while read _listsub; do
                _usub="$(echo $_listsub | awk '{print $2}')"
                [[ "$(grep -wc "$_usub" $suspensos)" == '0' ]] && _usts='ACTIVO' || _usts='SUSPENDIDO'
                msg1+="‚Ä¢ @$_usub - $_usts\n"
            done <<<"$(grep -w 'SUBREVENDA' $_patch/${callback_query_from_username}/${callback_query_from_username})" # Lee el archivo de control del revendedor
            
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
                --text "$(echo -e "$msg1")" \
                --parse_mode html
            return 0
        } || {
            ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
                --text "NO TIENES SUB-REVENDEDORES"
            return 0
        }
        
    # --- ACCESO DENEGADO ---
    else
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    fi
}

fun_ativar_rev() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Solo el administrador o un revendedor activo pueden acceder
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üîí ACTIVAR REVENDEDOR üîí\n\nIndica su usuario [Ej: @Nombre Del Usuario]:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

ativar_rev() {
    _revs=$1
    [[ -z "$_revs" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "Error")"
        return 0
    }
    
    # Verifica que el usuario a activar est√© efectivamente suspendido
    [[ ! -d "/etc/bot/suspensos/$_revs" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "¬°EL USUARIO NO EST√Å SUSPENDIDO!")" \
            --parse_mode html
        return 0
    }
    
    # Doble verificaci√≥n (redundante, pero mantenida)
    [[ ! -d "/etc/bot/suspensos/$_revs" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "¬°EL USUARIO NO EXISTE!")" \
            --parse_mode html
        return 0
    }

    # --- L√ìGICA DE ACTIVACI√ìN (solo para el ADMINISTRADOR) ---
    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
        
        # 1. Verifica y activa SUB-REVENDEDORES si los tiene
        [[ "$(grep -wc 'SUBREVENDA' /etc/bot/suspensos/$_revs/$_revs)" != '0' ]] && {
            while read _listsub3; do
                _usub3="$(echo $_listsub3 | awk '{print $2}')"
                _dir_users="/etc/bot/suspensos/$_usub3/usuarios"
                
                # Desbloquea los usuarios SSH del sub-revendedor
                [[ "$(ls $_dir_users | wc -l)" != '0' ]] && {
                    for _user in $(ls $_dir_users); do
                        usermod -U $_user
                    done
                }
                mv /etc/bot/suspensos/$_usub3 /etc/bot/revenda/$_usub3 # Mueve la carpeta a activos
                grep -w "$_usub3" $suspensos >> $ativos # Agrega la l√≠nea de suspensi√≥n a la lista de activos
            done <<<"$(grep -w 'SUBREVENDA' /etc/bot/suspensos/$_revs/$_revs)"
        }
        
        # 2. Activa el REVENDEDOR PRINCIPAL
        # Desbloquea los usuarios SSH del revendedor
        [[ "$(ls /etc/bot/suspensos/$_revs/usuarios | wc -l)" != '0' ]] && {
            for _user_ in $(ls /etc/bot/suspensos/$_revs/usuarios); do
                usermod -U $_user_
            done
        }
        mv /etc/bot/suspensos/$_revs /etc/bot/revenda/$_revs # Mueve la carpeta a activos
        
        # 3. Elimina el revendedor de la lista de suspendidos
        sed -i "/\b$_revs\b/d" $suspensos
        
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "ACTIVADO CON √âXITO")" \
            --parse_mode html
        return 0
        
    # --- ACCESO DENEGADO (Revendedores no pueden activar otros) ---
    } || {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "ACCESO DENEGADO")" \
            --parse_mode html
        return 0
    }
}

fun_susp_rev() {
    # Verifica suspensi√≥n del usuario que ejecuta el comando
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Solo el administrador o un revendedor activo pueden acceder
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
            --text "üîí SUSPENDER REVENDEDOR üîí\n\nIndica su usuario [Ej: @Nombre Del Usuario]:" \
            --reply_markup "$(ShellBot.ForceReply)"
    } || {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "üö´ ACCESO DENEGADO üö´"
        return 0
    }
}

susp_rev() {
    _revs=$1
    [[ -z "$_revs" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "Error")"
        return 0
    }
    
    # Verifica si el usuario ya est√° suspendido
    [[ -d "/etc/bot/suspensos/$_revs" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "¬°EL USUARIO YA EST√Å SUSPENDIDO!")" \
            --parse_mode html
        return 0
    }
    
    # Verifica si el usuario existe en el directorio de activos
    [[ ! -d "/etc/bot/revenda/$_revs" ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "¬°EL USUARIO NO EXISTE!")" \
            --parse_mode html
        return 0
    }
    
    # --- L√ìGICA DEL ADMINISTRADOR ---
    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
        
        # 1. Suspende a los SUB-REVENDEDORES si los tiene
        [[ "$(grep -wc 'SUBREVENDA' /etc/bot/revenda/$_revs/$_revs)" != '0' ]] && {
            while read _listsub3; do
                _usub3="$(echo $_listsub3 | awk '{print $2}')"
                _dir_users="/etc/bot/revenda/$_usub3/usuarios"
                
                # Suspende los usuarios SSH del sub-revendedor
                [[ "$(ls $_dir_users | wc -l)" != '0' ]] && {
                    for _user in $(ls $_dir_users); do
                        usermod -L $_user # Bloquea el login
                        pkill -f $_user # Mata las sesiones activas
                    done
                }
                mv /etc/bot/revenda/$_usub3 /etc/bot/suspensos/$_usub3 # Mueve la carpeta a suspendidos
                grep -w "$_usub3" $ativos >>$suspensos # Agrega la entrada de suspensi√≥n
            done <<<"$(grep -w 'SUBREVENDA' /etc/bot/revenda/$_revs/$_revs)"
        }
        
        # 2. Suspende el REVENDEDOR PRINCIPAL
        # Suspende los usuarios SSH del revendedor
        [[ "$(ls /etc/bot/revenda/$_revs/usuarios | wc -l)" != '0' ]] && {
            for _user_ in $(ls /etc/bot/revenda/$_revs/usuarios); do
                usermod -L $_user_
                pkill -f $_user_
            done
        }
        mv /etc/bot/revenda/$_revs /etc/bot/suspensos/$_revs # Mueve la carpeta a suspendidos
        grep -w "$_revs" $ativos >>$suspensos # Agrega la entrada de suspensi√≥n
        
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "SUSPENDIDO CON √âXITO")" \
            --parse_mode html
        return 0
        
    # --- L√ìGICA DEL REVENDEDOR (Suspendiendo solo Sub-revendedores) ---
    } || {
        # Verifica si el usuario a suspender es un sub-revendedor registrado bajo el revendedor actual
        [[ "$(grep -wc "$_revs" /etc/bot/revenda/${message_from_username}/${message_from_username})" != '0' ]] && {
            
            # Suspende los usuarios SSH del sub-revendedor
            [[ "$(ls /etc/bot/revenda/$_revs/usuarios | wc -l)" != '0' ]] && {
                for _user_ in $(ls /etc/bot/revenda/$_revs/usuarios); do
                    usermod -L $_user_
                    pkill -f $_user_
                done
            }
            mv /etc/bot/revenda/$_revs /etc/bot/suspensos/$_revs # Mueve la carpeta a suspendidos
            grep -w "$_revs" $ativos >>$suspensos # Agrega la entrada de suspensi√≥n
            
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "SUSPENDIDO CON √âXITO")" \
                --parse_mode html
            return 0
        } || {
            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                --text "$(echo -e "EL SUB-REVENDEDOR NO EXISTE")" \
                --parse_mode html
            return 0
        }
    }
}

infouserbot() {
    # Si el usuario tiene acceso de REVENDEDOR/SUB-REVENDEDOR (est√° en la lista de activos)
    [[ $(grep -wc ${message_from_username} $ativos) != '0' ]] && {
        _cont_limite=$(grep -w ${message_from_username} $ativos | awk '{print $4}') # L√≠mite total
        fun_verif_limite_rev ${message_from_username} # Ejecuta la funci√≥n para calcular el l√≠mite usado (_result)
        _cont_disp=$(echo $_cont_limite - $_result | bc) # L√≠mite disponible
        
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "<b>NOMBRE: </b> ${message_from_first_name[$(ShellBot.ListUpdates)]}\n<b>USUARIO: </b> "@${message_from_username[$(ShellBot.ListUpdates)]:-null}")\n<b>ID: </b> ${message_from_id[$(ShellBot.ListUpdates)]}\nACCESO: REVENTA\n<b>L√çMITE TOTAL:</b> $_cont_limite\n<b>L√çMITE RESTANTE:</b> $_cont_disp" \
            --parse_mode html
        return 0
    } || {
        # Si el usuario NO tiene acceso de REVENDEDOR
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "<b>NOMBRE: </b> ${message_from_first_name[$(ShellBot.ListUpdates)]}\n<b>USUARIO: </b> "@${message_from_username[$(ShellBot.ListUpdates)]:-null}")\n<b>ID: </b> ${message_from_id[$(ShellBot.ListUpdates)]} " \
            --parse_mode html
        return 0
    }
}


fun_menurevenda() {
    # Verifica suspensi√≥n
    [[ "$(grep -wc ${callback_query_from_username} $suspensos)" != '0' ]] && {
        ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
            --text "‚ö†Ô∏è ¬°EST√ÅS SUSPENDIDO! CONTACTA AL ADMINISTRADOR"
        return 0
    }
    # Si es el administrador o un revendedor activo
    [[ "${callback_query_from_id[$id]}" == "$id_admin" ]] || [[ "$(grep -wc ${callback_query_from_username} $ativos)" != '0' ]] && {
        ShellBot.editMessageText --chat_id ${callback_query_message_chat_id[$id]} \
            --message_id ${callback_query_message_message_id[$id]} \
            --text "SELECCIONA UNA OPCI√ìN ABAJO:" \
            --reply_markup "$(ShellBot.InlineKeyboardMarkup --button 'menu4')" # Muestra el men√∫ 'menu4' (Opciones de Reventa)
        return 0
    }
}

# LISTA MENU ADMIN
unset menu1
menu1=''
ShellBot.InlineKeyboardButton --button 'menu1' --line 1 --text 'CREAR USUARIO' --callback_data '_criaruser'
ShellBot.InlineKeyboardButton --button 'menu1' --line 2 --text 'CREAR TESTE' --callback_data '_criarteste'
ShellBot.InlineKeyboardButton --button 'menu1' --line 3 --text 'REMOVER' --callback_data '_deluser'
ShellBot.InlineKeyboardButton --button 'menu1' --line 4 --text 'SUSPENDER USUARIO' --callback_data '_sususer'
ShellBot.InlineKeyboardButton --button 'menu1' --line 5 --text 'REMOVER SUSPENSO' --callback_data '_ativauser'
ShellBot.InlineKeyboardButton --button 'menu1' --line 6 --text 'ALTERAR CONTRASE√ëA' --callback_data '_altsenha'
ShellBot.InlineKeyboardButton --button 'menu1' --line 7 --text 'ALTERAR LIMITE' --callback_data '_altlimite'
ShellBot.InlineKeyboardButton --button 'menu1' --line 8 --text 'ALTERAR FECHA' --callback_data '_altdata'
ShellBot.InlineKeyboardButton --button 'menu1' --line 9 --text 'USUARIOS ONLINE' --callback_data '_monitor'
ShellBot.InlineKeyboardButton --button 'menu1' --line 10 --text 'INFO USUARIOS' --callback_data '_verusers'
ShellBot.InlineKeyboardButton --button 'menu1' --line 11 --text 'REMOVER EXPIRADOS' --callback_data '_expirados'
ShellBot.InlineKeyboardButton --button 'menu1' --line 12 --text 'ALTERAR CONTRASE√ëA ROOT' --callback_data '_senharoot'
ShellBot.InlineKeyboardButton --button 'menu1' --line 1 --text 'INFO VPS' --callback_data '_infovps'
ShellBot.InlineKeyboardButton --button 'menu1' --line 2 --text 'OPTIMIZAR' --callback_data '_otimizar'
ShellBot.InlineKeyboardButton --button 'menu1' --line 3 --text 'ARCHIVOS' --callback_data '_arqdown'
ShellBot.InlineKeyboardButton --button 'menu1' --line 4 --text 'REVENTA' --callback_data '_opcoesrev'
ShellBot.InlineKeyboardButton --button 'menu1' --line 5 --text 'SPEEDTESTE' --callback_data '_speedteste'
ShellBot.InlineKeyboardButton --button 'menu1' --line 6 --text 'BACKUP USUARIOS' --callback_data '_backupusers'
ShellBot.InlineKeyboardButton --button 'menu1' --line 7 --text "AUTO BACKUP" --callback_data '_autobkp'
ShellBot.InlineKeyboardButton --button 'menu1' --line 8 --text 'RECORDATORIO' --callback_data '_relatorio'
ShellBot.InlineKeyboardButton --button 'menu1' --line 9 --text 'AYUDA' --callback_data '_ajuda'
ShellBot.regHandleFunction --function fun_adduser --callback_data _criaruser
ShellBot.regHandleFunction --function fun_add_teste --callback_data _criarteste
ShellBot.regHandleFunction --function fun_deluser --callback_data _deluser
ShellBot.regHandleFunction --function fun_sususer --callback_data _sususer
ShellBot.regHandleFunction --function fun_atiuser --callback_data _ativauser
ShellBot.regHandleFunction --function alterar_senha --callback_data _altsenha
ShellBot.regHandleFunction --function alterar_limite --callback_data _altlimite
ShellBot.regHandleFunction --function alterar_data --callback_data _altdata
ShellBot.regHandleFunction --function fun_down --callback_data _arqdown
ShellBot.regHandleFunction --function monitor_ssh --callback_data _monitor
ShellBot.regHandleFunction --function ver_users --callback_data _verusers
ShellBot.regHandleFunction --function fun_exp_user --callback_data _expirados
ShellBot.regHandleFunction --function alterar_senha_root --callback_data _senharoot
ShellBot.regHandleFunction --function otimizer --callback_data _otimizar
ShellBot.regHandleFunction --function speed_test --callback_data _speedteste
ShellBot.regHandleFunction --function infovps --callback_data _infovps
ShellBot.regHandleFunction --function backup_users --callback_data _backupusers
ShellBot.regHandleFunction --function fun_backauto --callback_data _autobkp
ShellBot.regHandleFunction --function relatorio_rev --callback_data _relatorio
ShellBot.regHandleFunction --function fun_ajuda --callback_data _ajuda
ShellBot.regHandleFunction --function fun_menurevenda --callback_data _opcoesrev
unset keyboard1
keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'menu1')"


# LISTA MENU REVENDEDOR
unset menu2
menu2=''
ShellBot.InlineKeyboardButton --button 'menu2' --line 1 --text 'CREAR USUARIO' --callback_data '_criaruser2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 1 --text 'CREAR TESTE' --callback_data '_criarteste2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 2 --text 'REMOVER' --callback_data '_deluser2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 2 --text 'SUSPENDER USUARIO' --callback_data '_sususer2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 2 --text 'REMOVER SUSPENSO' --callback_data '_ativauser2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 2 --text 'USUARIOS ONLINE' --callback_data '_monitor2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 3 --text 'ALTERAR LIMITE' --callback_data '_altlimite2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 3 --text 'INFO USUARIOS' --callback_data '_verusers2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 4 --text 'ALTERAR CONTRASE√ëA' --callback_data '_altsenha2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 4 --text 'REMOVER EXPIRADOS' --callback_data '_expirados2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 5 --text 'ALTERAR FECHA' --callback_data '_altdata2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 5 --text 'REVENTA' --callback_data '_opcoesrev2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 6 --text 'RECORDATORIO' --callback_data '_relatorio2'
ShellBot.InlineKeyboardButton --button 'menu2' --line 6 --text 'AYUDA' --callback_data '_ajuda2'
ShellBot.regHandleFunction --function fun_adduser --callback_data _criaruser2
ShellBot.regHandleFunction --function fun_add_teste --callback_data _criarteste2
ShellBot.regHandleFunction --function fun_deluser --callback_data _deluser2
ShellBot.regHandleFunction --function fun_sususer --callback_data _sususer2
ShellBot.regHandleFunction --function fun_atiuser --callback_data _ativauser2
ShellBot.regHandleFunction --function alterar_senha --callback_data _altsenha2
ShellBot.regHandleFunction --function alterar_limite --callback_data _altlimite2
ShellBot.regHandleFunction --function alterar_data --callback_data _altdata2
ShellBot.regHandleFunction --function monitor_ssh --callback_data _monitor2
ShellBot.regHandleFunction --function ver_users --callback_data _verusers2
ShellBot.regHandleFunction --function fun_exp_user --callback_data _expirados2
ShellBot.regHandleFunction --function relatorio_rev --callback_data _relatorio2
ShellBot.regHandleFunction --function fun_menurevenda --callback_data _opcoesrev2
ShellBot.regHandleFunction --function fun_ajuda --callback_data _ajuda2
unset keyboard2
keyboard2="$(ShellBot.InlineKeyboardMarkup -b 'menu2')"

#LISTA MUNU SUB REVENDEDOR
unset menu3
menu3=''
ShellBot.InlineKeyboardButton --button 'menu3' --line 1 --text 'CREAR USUARIO' --callback_data '_criaruser3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 1 --text 'CREAR TESTE' --callback_data '_criarteste3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 2 --text 'REMOVER' --callback_data '_deluser3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 2 --text 'SUSPENDER USUARIO' --callback_data '_sususer3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 2 --text 'REMOVER SUSPENSO' --callback_data '_ativauser3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 2 --text 'USUARIOS ONLINE' --callback_data '_monitor3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 3 --text 'ALTERAR LIMITE' --callback_data '_altlimite3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 3 --text 'INFO USUARIOS' --callback_data '_verusers3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 4 --text 'ALTERAR CONTRASE√ëA' --callback_data '_altsenha3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 4 --text 'REMOVER EXPIRADOS' --callback_data '_expirados3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 5 --text 'ALTERAR FECHA' --callback_data '_altdata3'
ShellBot.InlineKeyboardButton --button 'menu3' --line 5 --text 'AJUDA' --callback_data '_ajuda3'
ShellBot.regHandleFunction --function fun_adduser --callback_data _criaruser3
ShellBot.regHandleFunction --function fun_add_teste --callback_data _criarteste3
ShellBot.regHandleFunction --function fun_deluser --callback_data _deluser3
ShellBot.regHandleFunction --function fun_sususer --callback_data _sususer3
ShellBot.regHandleFunction --function fun_atiuser --callback_data _ativauser3
ShellBot.regHandleFunction --function alterar_senha --callback_data _altsenha3
ShellBot.regHandleFunction --function alterar_limite --callback_data _altlimite3
ShellBot.regHandleFunction --function alterar_data --callback_data _altdata3
ShellBot.regHandleFunction --function monitor_ssh --callback_data _monitor3
ShellBot.regHandleFunction --function ver_users --callback_data _verusers3
ShellBot.regHandleFunction --function fun_exp_user --callback_data _expirados3
ShellBot.regHandleFunction --function fun_ajuda --callback_data _ajuda3
unset keyboard3
keyboard3="$(ShellBot.InlineKeyboardMarkup -b 'menu3')"

#LISTA MENU OPCOES REVENDA
unset menu4
menu4=''
ShellBot.InlineKeyboardButton --button 'menu4' --line 1 --text 'ADICIONAR REVENDA' --callback_data '_addrev'
ShellBot.InlineKeyboardButton --button 'menu4' --line 2 --text 'REMOVER REVENDA' --callback_data '_delrev'
ShellBot.InlineKeyboardButton --button 'menu4' --line 3 --text 'ALTERAR LIMITE REVENDA' --callback_data '_limrev'
ShellBot.InlineKeyboardButton --button 'menu4' --line 4 --text 'ALTERAR FECHA REVENDA' --callback_data '_datrev'
ShellBot.InlineKeyboardButton --button 'menu4' --line 5 --text 'LISTAR REVENDA' --callback_data '_listrev'
ShellBot.InlineKeyboardButton --button 'menu4' --line 6 --text 'SUSPENDER REVENDA' --callback_data '_susprevendas'
ShellBot.InlineKeyboardButton --button 'menu4' --line 6 --text 'ATIVAR REVENDA' --callback_data '_ativarrevendas'
ShellBot.regHandleFunction --function fun_add_revenda --callback_data _addrev
ShellBot.regHandleFunction --function fun_del_rev --callback_data _delrev
ShellBot.regHandleFunction --function fun_lim_rev --callback_data _limrev
ShellBot.regHandleFunction --function fun_dat_rev --callback_data _datrev
ShellBot.regHandleFunction --function fun_list_rev --callback_data _listrev
ShellBot.regHandleFunction --function fun_susp_rev --callback _susprevendas
ShellBot.regHandleFunction --function fun_ativar_rev --callback _ativarrevendas
unset keyboard4
keyboard4="$(ShellBot.InlineKeyboardMarkup -b 'menu4')"

while :; do
    [[ -e "/etc/SSHPlus/backups/backup.vps" ]] && {
        backup_auto
    }
    #Obtem as atualiza√ß√µes
    ShellBot.getUpdates --limit 100 --offset $(ShellBot.OffsetNext) --timeout 35
    #Lista o √≠ndice das atualiza√ß√µes
    for id in $(ShellBot.ListUpdates); do
        #Inicio thread
        (
            ShellBot.watchHandle --callback_data ${callback_query_data[$id]}
            # Requisi√ß√µes somente no privado.
            [[ ${message_chat_type[$id]} != 'private' ]] && continue
            [[ ${message_text[$id]} ]] || restaure_backup
            CAD_ARQ=/tmp/cad.${message_from_id[$id]}
            if [[ ${message_entities_type[$id]} == bot_command ]]; then
                #Verifica se a mensagem enviada pelo usu√°rio √© um comando v√°lido.
                case ${message_text[$id]} in
                *)
                    :
                    #comandos
                    comando=(${message_text[$id]})
					[[ "${comando[0]}" = "/start" ]] && msg_bot
                    [[ "${comando[0]}" = "/start" ]] && msg_bem_vindo
                    [[ "${comando[0]}" = "/menu" ]] && fun_menu
                    [[ "${comando[0]}" = "/info" ]] && infouserbot
                    [[ "${comando[0]}" = "/hrlp" || "${comando[0]}" = "/ajuda" ]] && fun_ajuda
                    [[ "${comando[0]}" = "/bot" || "${comando[0]}" = "/sobre" ]] && sobremim
                    ;;
                esac
            fi
            if [[ ${message_reply_to_message_message_id[$id]} ]]; then
                # Analisa a interface de resposta.
                case ${message_reply_to_message_text[$id]} in
                'üë§ CREAR USUARIO üë§\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ "$(awk -F : '$3 >= 1000 { print $1 }' /etc/passwd | grep -w ${message_text[$id]} | wc -l)" != '0' ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro! USUARIO INVALIDO ‚ùå\n\n‚ö†Ô∏è Informe Outro Nome..")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    [ "${message_text[$id]}" == 'root' ] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå ERRO! USUARIO INVALIDO ‚ùå\n\n‚ö†Ô∏è Informe Outro Nome..")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    sizemin=$(echo -e ${#message_text[$id]})
                    [[ "$sizemin" -lt '4' ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro !\n\nUse no m√≠nimo 4 caracteres\n[EX: test]")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    sizemax=$(echo -e ${#message_text[$id]})
                    [[ "$sizemax" -gt '10' ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro !\n\nUse no maximo 8 caracteres\n[EX: vpn]")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    echo "Nome: ${message_text[$id]}" >$CAD_ARQ
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Contrase√±a:' \
                        --reply_markup "$(ShellBot.ForceReply)" # For√ßa a resposta.
                    ;;
                'Contrase√±a:')
                    sizepass=$(echo -e ${#message_text[$id]})
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ "$sizepass" -lt '4' ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro !\n\nUse no m√≠nimo 4 caracteres\n[EX: 1234]")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    echo "Contrase√±a: ${message_text[$id]}" >>$CAD_ARQ
                    # Pr√≥ximo campo.
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Limite:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'Limite:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\nUltilize apenas numeros [EX: 1]")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
                        _limTotal=$(grep -w "${message_from_username}" $ativos | awk '{print $4}')
                        fun_verif_limite_rev ${message_from_username}
                        _limsomarev2=$(echo "$_result + ${message_text[$id]}" | bc)
                        [[ "$_limsomarev2" -gt "$_limTotal" ]] && {
                            _restant1=$(($_limTotal - $_result))
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Vc nao tem limite suficiente\n\nLimite disponivel: $_restant1 ")" \
                                --parse_mode html
                            >$CAD_ARQ
                            break
                        }
                    }
                    echo "Limite: ${message_text[$id]}" >>$CAD_ARQ
                    # Pr√≥ximo campo.
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Duracion: ' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;

                'Duracion:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\nUltilize apenas numeros [EX: 30]")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    info_data=$(date '+%d/%m/%C%y' -d " +${message_text[$id]} days")
                    echo "Validade: $info_data" >>$CAD_ARQ
                    criar_user $CAD_ARQ
                    [[ "(grep -w ${message_text[$id]} /etc/passwd)" = '0' ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e ‚ùå Erro ao criar usuario !)" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    [[ "$(ls /etc/bot/arquivos | wc -l)" != '0' ]] && {
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text 'üì• ARQUIVOS DISPONIVEIS üì•\n\nDeseja baixar? Sim ou Nao?:' \
                            --reply_markup "$(ShellBot.ForceReply)"
                    } || {
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text "<b>‚úÖ CREADO CON EXITO ‚úÖ</b>\n\nUSUARIO: <code>$(awk -F " " '/Nome/ {print $2}' $CAD_ARQ)</code>\nCONTRASE√ëA: <code>$(awk -F " " '/Contrase√±a/ {print $2}' $CAD_ARQ)</code>\nLIMITE: $(awk -F " " '/Limite/ {print $2}' $CAD_ARQ)\nEXPIRA EL: $(awk -F " " '/Validade/ {print $2}' $CAD_ARQ)" \
                            --parse_mode html
                        break
                    }
                    ;;
                'üì• ARQUIVOS DISPONIVEIS üì•\n\nDeseja baixar? Sim ou Nao?:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([A-Za-z]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Opcao Invalida ‚ùå\n\n‚ö†Ô∏è Ultilize apenas letras [EX: sim ou nao]")" \
                            --parse_mode html
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text "<b>‚úÖ CREADO CON EXITO ‚úÖ</b>\n\nUSUARIO: <code>$(awk -F " " '/Nome/ {print $2}' $CAD_ARQ)</code>\nCONTRASE√ëA: <code>$(awk -F " " '/Contrase√±a/ {print $2}' $CAD_ARQ)</code>\nLIMITE: $(awk -F " " '/Limite/ {print $2}' $CAD_ARQ)\nEXPIRA EL: $(awk -F " " '/Validade/ {print $2}' $CAD_ARQ)" \
                            --parse_mode html
                        break
                    }
                    [[ "${message_text[$id]}" = @(Sim|sim|SIM) ]] && {
                        msg_cli="‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†\n"
                        msg_cli+="<b>ARQUIVOS PRE-CONFIGURADOS </b>‚ùó\n"
                        msg_cli+="‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†\n\n"
                        for _file in $(ls /etc/bot/arquivos); do
                            i=$(($i + 1))
                            msg_cli+="<b>[$i]</b> - $_file\n"
                        done
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "$msg_cli")" \
                            --parse_mode html
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text 'Informe o Numero do Arquivo:' \
                            --reply_markup "$(ShellBot.ForceReply)"
                    } || {
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text "<b>‚úÖ CREADO CON EXITO ‚úÖ</b>\n\nUSUARIO: <code>$(awk -F " " '/Nome/ {print $2}' $CAD_ARQ)</code>\nCONTRASE√ëA: <code>$(awk -F " " '/Contrase√±a/ {print $2}' $CAD_ARQ)</code>\nLIMITE: $(awk -F " " '/Limite/ {print $2}' $CAD_ARQ)\nEXPIRA EL: $(awk -F " " '/Validade/ {print $2}' $CAD_ARQ)" \
                            --parse_mode html
                    }
                    ;;
                'Informe o Numero do Arquivo:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Opcao Invalida ‚ùå \n\n‚ö†Ô∏è Ultilize apenas numeros [EX: 1]")" \
                            --parse_mode html
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text "<b>‚úÖ CREADO CON EXITO ‚úÖ</b>\n\nUSUARIO: <code>$(awk -F " " '/Nome/ {print $2}' $CAD_ARQ)</code>\nCONTRASE√ëA: <code>$(awk -F " " '/Contrase√±a/ {print $2}' $CAD_ARQ)</code>\nLIMITE: $(awk -F " " '/Limite/ {print $2}' $CAD_ARQ)\nEXPIRA EL: $(awk -F " " '/Validade/ {print $2}' $CAD_ARQ)" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    fun_download ${message_text[$id]} $CAD_ARQ
                    # Limpa o arquivo tempor√°rio.
                    >$CAD_ARQ
                    break
                    ;;
                'üóë REMOVER USUARIO üóë\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    fun_del_user ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "‚úÖ *Removido com sucesso.* üöÆ" \
                        --parse_mode markdown
                    ;;
                'üóë SUSPENDER USUARIO üóë\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    fun_sus_user ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "‚úÖ *Suspendido com sucesso.* üöÆ" \
                        --parse_mode markdown
                    ;;
                'üóë REMOVER SUSPENSO üóë\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    fun_ati_user ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "‚úÖ *Usuario ativado com sucesso.* üöÆ" \
                        --parse_mode markdown
                    ;;
                'üîê Cambiar Contrase√±a üîê\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    fun_verif_user ${message_text[$id]}
                    echo "$_erro"
                    [[ "$_erro" == '1' ]] && break
                    echo "${message_text[$id]}" >/tmp/name-s
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Nova senha:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'Nova senha:')
                    sizepass=$(echo -e ${#message_text[$id]})
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ "$sizepass" -lt '4' ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro !\n\n‚ö†Ô∏è Use m√≠nimo 4 caracteres [EX: 1234]")" \
                            --parse_mode html
                        break
                    }
                    alterar_senha_user $(cat /tmp/name-s) ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "$(echo -e "=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n<b>‚úÖ CONTRASE√ëA ALTERADA !</b> !\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n\n<b>Usuario:</b> $(cat /tmp/name-s)\n<b>Nova senha:</b> ${message_text[$id]}")" \
                        --parse_mode html
                    rm /tmp/name-s >/dev/null 2>&1
                    ;;
                    'üîê Alterar Contrase√±a ROOT üîê\n\nDigite a nova senha:')
                    [[ "$_erro" == '1' ]] && break
                    alterar_senha_root_exec
                    ;;
                    'ALTERAR CONTRASE√ëA ROOT')
                    alterar_senha_root
                    ;;
                'üë• Alterar Limite üë•\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    echo $_erro segundo
                    fun_verif_user ${message_text[$id]}
                    echo "$_erro"
                    [[ "$_erro" == '1' ]] && break
                    echo "${message_text[$id]}" >/tmp/name-l
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Nuevo limite:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'Nuevo limite:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\n‚ö†Ô∏è Ultilize apenas numeros [EX: 1]")" \
                            --parse_mode html
                        break
                    }
                    alterar_limite_user $(cat /tmp/name-l) ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "$(echo -e "=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n<b>‚úÖ LIMITE ALTERADO !</b> !\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n\n<b>Usuario:</b> $(cat /tmp/name-l)\n<b>Novo Limite:</b> ${message_text[$id]}")" \
                        --parse_mode html
                    rm /tmp/name-l >/dev/null 2>&1
                    ;;
                '‚è≥ Alterar Data ‚è≥\n\nNome do usuario:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    fun_verif_user ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    echo "${message_text[$id]}" >/tmp/name-d
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'informe os dias ou data:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'informe os dias ou data:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9/]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro! Siga o exemplo\n\nDias formato [EX: 30]\nData formato [EX: 30/12/2019]")" \
                            --parse_mode html
                        break
                    }
                    alterar_data_user $(cat /tmp/name-d) ${message_text[$id]}
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "$(echo -e "=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n<b>‚úÖ FECHA ALTERADA !</b> !\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n\n<b>Usuario:</b> $(cat /tmp/name-d)\n<b>Nova Data:</b> $udata")" \
                        --parse_mode html
                    rm /tmp/name-d >/dev/null 2>&1
                    ;;
                '[1] - ADICIONAR ARQUIVO\n[2] - EXCLUIR ARQUIVO\n\nInforme a opcao [1-2]:')
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\n‚ö†Ô∏è Ultilize apenas numeros [EX: 1 ou 2]")" \
                            --parse_mode html
                        break
                    }
                    if [[ "${message_text[$id]}" = '1' ]]; then
                        ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                            --text "üì§ HOSPEDAR ARQUIVOS üì§\n\nEnvie-me o arquivo:" \
                            --reply_markup "$(ShellBot.ForceReply)"
                    elif [[ "${message_text[$id]}" = '2' ]]; then
                        [[ $(ls /etc/bot/arquivos | wc -l) != '0' ]] && {
                            msg_cli1="‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†\n"
                            msg_cli1+="üöÄ<b> ARQUIVOS HOSPEDADOS </b>\n"
                            msg_cli1+="‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†‚â†\n\n"
                            for _file in $(ls /etc/bot/arquivos); do
                                i=$(($i + 1))
                                msg_cli1+="<b>[$i]</b> - $_file\n"
                            done
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "$msg_cli1")" \
                                --parse_mode html
                            ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                --text "üóëExcluir Arquivo\nInforme o Numero do Arquivo:" \
                                --reply_markup "$(ShellBot.ForceReply)"
                        } || {
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "Nao existe arquivos disponiveis")" \
                                --parse_mode html
                            break
                        }
                    else
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Opcao Invalida")" \
                            --parse_mode html
                        break
                    fi
                    ;;
                'üóëExcluir Arquivo\nInforme o Numero do Arquivo:')
                    [[ "${message_from_id[$id]}" != "$id_admin" ]] && break
                    Opc1=${message_text[$id]}
                    echo $Opc1
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ao Excluir arquivo ! \n\n‚ö†Ô∏è Ultilize apenas numeros [EX: 1]")" \
                            --parse_mode html
                        break
                    } || {
                        echo "opcao $Opc1"
                        _DirArq=$(ls /etc/bot/arquivos)
                        i=0
                        unset _Pass
                        while read _Arq; do
                            i=$(expr $i + 1)
                            _oP=$i
                            [[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
                            echo -e "[$i] - $_Arq"
                            _Pass+="\n${_oP}:${_Arq}"
                        done <<<"${_DirArq}"
                        _file=$(echo -e "${_Pass}" | grep -E "\b$Opc1\b" | cut -d: -f2)
                        [[ -e /etc/bot/arquivos/$_file ]] && {
                            rm /etc/bot/arquivos/$_file
                            ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                --text "‚úÖ *Excluido com sucesso* ‚úÖ" \
                                --parse_mode markdown
                            break
                        } || {
                            ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                --text "$(echo -e "‚ùå Opcao invalida")"
                            break
                        }
                    }
                    ;;
                'üì§ HOSPEDAR ARQUIVOS üì§\n\nEnvie-me o arquivo:')
                    if [ "${update_id[$id]}" ]; then
                        # Monitora o envio de arquivos
                        [[ ${message_document_file_id[$id]} ]] && file_id=${message_document_file_id[$id]} && download_file=1
                        # Verifica se o download est√° ativado.
                        [[ $download_file -eq 1 ]] && {
                            file_id=($file_id)
                            ShellBot.getFile --file_id "${file_id[0]}"
                            ShellBot.downloadFile --file_path ${return[file_path]} --dir "/tmp/file" && {
                                msg='*‚úÖ Arquivo hospedado com sucesso.*\n\n'
                                msg+="*üì§ Informa√ß√µes*\n\n"
                                msg+="*Nome*: ${message_document_file_name}\n"
                                msg+="*Salvo em*: /etc/bot/arquivos"
                                ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                    --text "$(echo -e "$msg")" \
                                    --parse_mode markdown
                                mv /tmp/file/$(ls -1rt /tmp/file | tail -n1) /etc/bot/arquivos/${message_document_file_name}
                                break
                            }
                        } || {
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Erro ao receber arquivo ‚ùå")" \
                                --parse_mode markdown
                            break
                        }
                    fi
                    ;;
                'Deseja restaurar ? [sim | nao]')
                    Resp=${message_text[$id]}
                    [[ ${message_from_id[$id]} != ${id_admin} ]] && break
                    [[ $Resp != ?(+|-)+([a-z]) ]] && {
                        ShellBot.sendMessage --chat_id ${id_admin} \
                            --text "$(echo -e "‚ùå Erro ! \n\n‚ö†Ô∏è Ultilize apenas sim ou nao")" \
                            --parse_mode html
                        break
                    }
                    [[ "$Resp" = @(Sim|sim|SIM) ]] && {
                        filebkp=$(ls /tmp | grep '.vps')
                        [[ -e /tmp/$filebkp ]] && {
                            mv /tmp/$filebkp /backup.vps
                            cd /
                            tar -xvf backup.vps
                            rm /backup.vps
                            ShellBot.sendMessage --chat_id ${id_admin} \
                                --text "$(echo -e "‚úÖ Backup restaurado\ncom sucesso!")" \
                                --parse_mode html
                            break
                        }
                    }
                    break
                    ;;
                    # FUNCOES DE GESTAO REVENDA
                    #
                    # Adicionar, remover, limite, data, suspencao, relatorio
                    #
                'üë• ADICIONAR REVENDEDOR üë•\n\nInforme o nome:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    echo "Nome: ${message_text[$id]}" >$CAD_ARQ
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Informe o user dele [Ex: @Nome Do Usuario]:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'Informe o user dele [Ex: @Nome Do Usuario]:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    _VAR1=$(echo -e ${message_text[$id]} | awk -F '@' {'print $2'})
                    [[ -z $_VAR1 ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro \n\n‚ö†Ô∏è Informe o user [EX: @Nome Do Usuario]")" \
                            --parse_mode html
                        break
                    }
                    [[ -d /etc/bot/revenda/$_VAR1 ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå O Revendedor ${message_text[$id]} ja existe")" \
                            --parse_mode html
                        break
                    }
                    echo "User: ${message_text[$id]}" >>$CAD_ARQ
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Quantas SSH ele pode criar:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'Quantas SSH ele pode criar:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\n‚ö†Ô∏è Ultilize apenas numeros [EX: 10]")" \
                            --parse_mode html
                        break
                    }
                    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
                        _limTotal=$(grep -w "${message_from_username}" $ativos | awk '{print $4}')
                        fun_verif_limite_rev ${message_from_username}
                        _limsomarev=$(echo "$_result + ${message_text[$id]}" | bc)
                        [[ "$_limsomarev" -gt "$_limTotal" ]] && {
                            _restant1=$(($_limTotal - $_result))
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Vc nao tem limite suficiente\n\nLimite disponivel: $_restant1 ")" \
                                --parse_mode html
                            break
                        }
                    }
                    echo "Limite: ${message_text[$id]}" >>$CAD_ARQ
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text 'Quantos dias de acesso:' \
                        --reply_markup "$(ShellBot.ForceReply)"
                    ;;
                'Quantos dias de acesso:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    echo "Validade: ${message_text[$id]}" >>$CAD_ARQ
                    _clientrev=$(cat $CAD_ARQ)
                    criar_rev $CAD_ARQ
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "‚úÖ CREADO CON EXITO. ‚úÖ\n\n$(<$CAD_ARQ)\n\nBOT: @${message_reply_to_message_from_username}" \
                        --parse_mode html
                    ;;
                    # REMOVE REVENDEDOR
                'üóë REMOVER REVENDEDOR üóë\n\nInforme o user dele [Ex: @Nome Do Usuario]:')
                    echo -e "${message_text[$id]}" >$CAD_ARQ
                    _Var=$(sed -n '1 p' $CAD_ARQ | awk -F '@' {'print $2'})
                    [[ -z $_Var ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå User invalido")" \
                            --parse_mode html
                        break
                    }
                    del_rev $_Var
                    break
                    ;;
                    # ALTERAR LIMITE
                '‚ôæ ALTERAR LIMITE REVENDA ‚ôæ\n\nInforme o user dele [Ex: @Nome Do Usuario]:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    echo -e "Revendedor: ${message_text[$id]}" >$CAD_ARQ
                    _Var1=$(sed -n '1 p' $CAD_ARQ | awk -F '@' {'print $2'})
                    [[ -z $_Var1 ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Nome invalido !")" \
                            --parse_mode html
                        break
                    }
                    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
                        [[ $(grep -wc $_Var1 $ativos) != '0' ]] && {
                            ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                --text 'Informe o Limite SSH:' \
                                --reply_markup "$(ShellBot.ForceReply)"
                        } || {
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Revendedor ${message_text[$id]} nao existe")" \
                                --parse_mode html
                            break
                        }
                    }
                    [[ $(grep -w ${message_from_username} $ativos | awk '{print $NF}') == 'revenda' ]] && {
                        [[ "$(grep -wc "$_Var1" /etc/bot/revenda/${message_from_username}/${message_from_username})" != '0' ]] && {
                            ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                --text 'Informe o Limite SSH:' \
                                --reply_markup "$(ShellBot.ForceReply)"
                        } || {
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå O Sub-revendedor nao existe")" \
                                --parse_mode html
                            break
                        }
                    }
                    ;;
                'Informe o Limite SSH:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\nUltilize apenas numeros [EX: 1]")" \
                            --parse_mode html
                        break
                    }
                    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
                        _limTotal=$(grep -w "${message_from_username}" $ativos | awk '{print $4}')
                        fun_verif_limite_rev ${message_from_username}
                        _limsomarev=$(echo "$_result + ${message_text[$id]}" | bc)

                        [[ $(grep -wc 'SUBREVENDA' /etc/bot/revenda/${message_from_username}/${message_from_username}) != '0' ]] && {
                            _limsomarev2=$(echo "$(grep -w 'SUBREVENDA' /etc/bot/revenda/${message_from_username}/${message_from_username} | awk {'print $4'} | paste -s -d + | bc)" + "${message_text[$id]}" | bc)
                        } || {
                            _limsomarev2='0'
                        }
                        [[ "$_limsomarev2" -ge "$_limTotal" ]] && {
                            echo $_limsomarev2
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Vc nao tem limite suficiente")" \
                                --parse_mode html
                            break
                        }
                        [[ "$_limsomarev" -gt "$_limTotal" ]] && {
                            [[ "$_limTotal" == "$(($_limTotal - $_result))" ]] && _restant1='0' || _restant1=$(($_limTotal - $_result))
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Vc nao tem limite suficiente\n\nLimite restante: $_restant1 ")" \
                                --parse_mode html
                            break
                        }
                    }
                    echo -e "Limite: ${message_text[$id]}" >>$CAD_ARQ
                    lim_rev $CAD_ARQ
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "$(echo -e "=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n<b>‚úÖ LIMITE REVENDA ALTERADO !</b> !\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n\n$(<$CAD_ARQ)")" \
                        --parse_mode html
                    # ALTERAR FECHA
                    ;;
                'üìÜ ALTERAR FECHA REVENDA üìÜ\n\nInforme o user dele [Ex: @Nome Do Usuario]:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    _VAR1=$(echo -e ${message_text[$id]} | awk -F '@' {'print $2'})
                    [[ -z $_VAR1 ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "Revendedor ${message_text[$id]} nao existe")" \
                            --parse_mode html
                        break
                    }
                    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
                        [[ $(grep -wc $_VAR1 $ativos) != '0' ]] && {
                            echo -e "Revendedor: ${message_text[$id]}" >$CAD_ARQ
                            ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                --text 'Dias de acesso [Ex: 30]:' \
                                --reply_markup "$(ShellBot.ForceReply)"
                        } || {
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå O Revendedor ${message_text[$id]} nao existe")" \
                                --parse_mode html
                            break
                        }
                    } || {
                        [[ $(grep -w ${message_from_username} $ativos | awk '{print $NF}') == 'revenda' ]] && {
                            [[ "$(grep -wc "$_VAR1" /etc/bot/revenda/${message_from_username}/${message_from_username})" != '0' ]] && {
                                echo -e "Revendedor: ${message_text[$id]}" >$CAD_ARQ
                                ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                                    --text 'Dias de acesso [Ex: 30]:' \
                                    --reply_markup "$(ShellBot.ForceReply)"
                            } || {
                                ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                    --text "$(echo -e "‚ùå O SubRevendedor ${message_text[$id]} nao existe")" \
                                    --parse_mode html
                                break
                            }
                        }
                    }
                    ;;
                'Dias de acesso [Ex: 30]:')
                    verifica_acesso
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\nUltilize apenas numeros [EX: 30]")" \
                            --parse_mode html
                        break
                    }
                    echo -e "Data: ${message_text[$id]}" >>$CAD_ARQ
                    dat_rev $CAD_ARQ
                    [[ "$_erro" == '1' ]] && break
                    ShellBot.sendMessage --chat_id ${message_from_id[$id]} \
                        --text "$(echo -e "=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n<b>‚úÖ FECHA REVENDA ALTERADA !</b> !\n=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó\n\n$(<$CAD_ARQ)")" \
                        --parse_mode html
                    ;;
                    # SUSPENDER REVENDEDOR
                'üîí SUSPENDER REVENDEDOR üîí\n\nInforme o user dele [Ex: @Nome Do Usuario]:')
                    _VAR1=$(echo -e ${message_text[$id]} | awk -F '@' {'print $2'})
                    [[ -z $_VAR1 ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Revendedor ${message_text[$id]} nao existe")" \
                            --parse_mode html
                        break
                    }
                    susp_rev $_VAR1
                    break
                    ;;
                    # ATIVAR REVENDEDOR
                'üîí ATIVAR REVENDEDOR üîí\n\nInforme o user dele [Ex: @Nome Do Usuario]:')
                    _VAR1=$(echo -e ${message_text[$id]} | awk -F '@' {'print $2'})
                    [[ -z $_VAR1 ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Revendedor ${message_text[$id]} nao existe")" \
                            --parse_mode html
                        break
                    }
                    ativar_rev $_VAR1
                    break
                    ;;
                'üë§ CREAR TESTE üë§\n\nQuantas horas deve durar EX: 1:')
                    verifica_acesso
                    echo $_erro
                    [[ "$_erro" == '1' ]] && break
                    [[ ${message_text[$id]} != ?(+|-)+([0-9]) ]] && {
                        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                            --text "$(echo -e "‚ùå Erro ! \n\nUltilize apenas numeros [EX: 1]")" \
                            --parse_mode html
                        >$CAD_ARQ
                        break
                    }
                    [[ "${message_from_id[$id]}" != "$id_admin" ]] && {
                        _limTotal=$(grep -w "${message_from_username}" $ativos | awk '{print $4}')
                        fun_verif_limite_rev ${message_from_username}
                        _limsomarev2=$(echo "$_result + 1" | bc)
                        [[ "$_limsomarev2" -gt "$_limTotal" ]] && {
                            ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
                                --text "$(echo -e "‚ùå Vc nao tem limite suficiente")" \
                                --parse_mode html
                            >$CAD_ARQ
                            break
                        }
                    }
                    fun_teste ${message_text[$id]}
                    ;;
                esac
            fi
        ) &
    done
done
#FIM
